\newpage

\section{Dependent Type System}

\subsection{Properties of Context Application}

\begin{lemma}[\ContextApplicationIsIdempotentName]
  \label{lemma:\ContextApplicationIsIdempotentName}
  \ContextApplicationIsIdempotentBody
\end{lemma}
\proof
By induction on the well formedness of context. Case \rul{AC-Empty},
\rul{AC-Var}, and \rul{AC-EVar} are trivial. We discuss \rul{AC-SolvedEVar} below.

\begin{itemize}
  \item Case \[\ACSolvedEVar\]
    \begin{longtable}[l]{lll}
      & $ \applye {\tctx, \genA = \tau} {\applye {\tctx, \genA = \tau} \sigma} =
      \applye {\tctx, \genA = \tau} {\applye \tctx {\sigma \subst \genA
          \tau}} $ & By definition \\
      & $\tctx \byinf \tau \infto \star$ & Given \\
      & $\genA \notin \tctx$ & Given \\
      & $\genA \notin FV(\tau)$ & By above propositions \\
      & $\genA \notin FV(\sigma \subst \genA \tau)$ & Follows directly \\
      & $\genA \notin FV(\applye \tctx {\sigma \subst \genA \tau})$ & Follows
      directly \\
      & $\applye {\tctx, \genA = \tau} {\applye \tctx {\sigma \subst \genA
          \tau}} = \applye {\tctx} {\applye \tctx {\sigma \subst \genA \tau}}$ &
      Substitute fresh variable \\
      & $ = \applye \tctx {\sigma \subst \genA \tau}$ & By induction hypothesis
      \\
      & $ = \applye {\tctx, \genA = \tau} \sigma$ & By definition of context application
    \end{longtable}
\end{itemize}
\qed

\begin{lemma}[\ReductionPreservesFullySubstitutionName]
  \label{lemma:\ReductionPreservesFullySubstitutionName}
  \ReductionPreservesFullySubstitutionBody
\end{lemma}
\proof
Follows directly from the definition of context substitution and reduction.
\qed

\begin{lemma}[\ContextApplicationOverReductionName]
  \label{lemma:\ContextApplicationOverReductionName}
  \ContextApplicationOverReductionBody
\end{lemma}
\proof

By induction on the reduction derivation.

\begin{itemize}
  \item Case \[\RApp\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx {e_1} \redto \applye \tctx {e_1'}$& By induction
      hypothesis \\
      & $\applye \tctx {e_1~ e_2}$ & \\
      & $ = \applye \tctx {e_1} ~ \applye \tctx {e_2}$ & By property of
      substitution  \\
      & $\redto \applye \tctx {e_1'} ~ \applye \tctx {e_2}$& By \rul{R-App} \\
      & $= \applye \tctx {e_1' ~ e_2}$& By property of substitution
    \end{longtable}
  \item Case \[\RBeta\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx {(\blam x \sigma {e_1}) ~ e_2}$ & \\
      & $= {(\blam x {\applye \tctx \sigma} {\applye \tctx {e_1}}) ~
        \applye \tctx {e_2}}$ & By
      definition of substitution \\
      & $\redto (\applye \tctx {e_1}) \subst x {\applye \tctx {e_2}}$& By
      \rul{R-Beta} \\
      & $= \applye \tctx {e_1 \subst x {e_2}}$& By property of substitution
    \end{longtable}
  \item Case \[\RCastDown\]
    Follows directly from induction hypothesis.
  \item Case \[\RCastDownUp\]
    Follows directly from induction hypothesis.
\end{itemize}

\qed

\begin{lemma}[\OutputIsFullySubstitutedName]
  \label{lemma:OutputIsFullySubstituted}
  \OutputIsFullySubstitutedBody
\end{lemma}
\proof
By induction on typing derivation.
\begin{itemize}
  \item Case \rul{A-Ax}, \rul{A-EVar}, \rul{A-SolvedEVar}, \rul{A-Pi} follows
    directly from $\applye \tctx \star = \star$.
  \item Case \[\AVar\]
    \begin{longtable}[l]{lll}
    & $\applye \tctx {\applye \tctx \sigma} = \applye \tctx \sigma$ & By
    Lemma~\ref{lemma:\ContextApplicationIsIdempotentName}\\
    \end{longtable}
  \item Case \[\ALamAnn\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx {\bpi x {\applye \tctx {\sigma_1}} {\sigma_2}} =
      \bpi x {\applye \tctx {\applye \tctx {\sigma_1}}} {\applye \tctx
        {\sigma_2}}$
      & Follows from definition of context substitution \\
      &$=\bpi x {\applye \tctx {\sigma_1}} {\applye \tctx {\sigma_2}}$& By Lemma~\ref{lemma:\ContextApplicationIsIdempotentName}\\
      &$\applye {\tctx, x: \sigma_1} {\sigma_2} = \sigma_2$ & By hypothesis\\
      &$\applye {\tctx} {\sigma_2} = \sigma_2$& Follows from definition of
      context substitution\\
      &$\applye \tctx {\bpi x {\applye \tctx {\sigma_1}} {\sigma_2}} =
      {\bpi x {\applye \tctx {\sigma_1}} {\sigma_2}}
      $ & By above equalities
    \end{longtable}
  \item Case \[\AApp\]
    \begin{longtable}[l]{lll}
      &$\applye \tctx {\bpi x {\sigma_1} {\sigma_2}} = \bpi x {\sigma_1}
      {\sigma_2}$ & By hypothesis\\
      &$\applye \tctx {\sigma_2} = \sigma_2$& Follows directly from above\\
      &$\applye \tctx {\applye \tctx e} = \applye \tctx e$& By
      Lemma~\ref{lemma:\ContextApplicationIsIdempotentName} \\
      &$\applye \tctx {\sigma_2 \subst x {\applye \tctx {e_1}}}$ & \\
      &$=\applye \tctx {\sigma_2} \subst x {\applye \tctx {\applye \tctx {e_1}}}$&
      Context application is distributed over substitution \\
      &$={\sigma_2} \subst x {\applye \tctx{e_1}}$& By above equalities
    \end{longtable}
  \item Case \[\ACastDn\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx {\sigma_1} = {\sigma_1}$ & By hypothesis \\
      & $\applye \tctx {\sigma_2} = {\sigma_2}$ & By Lemma~\ref{lemma:\ReductionPreservesFullySubstitutionName} \\
    \end{longtable}
  \item Case \[\ACastUp\]
    Follows directly from Lemma~\ref{lemma:\ContextApplicationIsIdempotentName}
\end{itemize}
\qed

\begin{lemma}[\ContextApplicationInContextName]
  \label{lemma:\ContextApplicationInContextName}
  \ContextApplicationInContextBody
\end{lemma}
\proof
By induction on the typing relation.
\begin{itemize}
\item Case \rul{A-AX}, \rul{A-EVar} and \rul{A-SolvedEVar} follows directly.
\item Case \[\AVar\]
  If $x = y$, then result type is $\applye {\tctx} {\applye \tctx \tau} =
  \applye \tctx \tau$ by Lemma~\ref{lemma:\ContextApplicationIsIdempotentName}.
  Otherwise the result is the same.
\item The rest cases follows directly from the hypothesis.
\end{itemize}
\qed

\begin{lemma}[\ReverseContextApplicationInContextName]
  \label{lemma:\ReverseContextApplicationInContextName}
  \ReverseContextApplicationInContextBody
\end{lemma}
\proof
By induction on the typing relation.
\begin{itemize}
\item Case \rul{A-AX}, \rul{A-EVar} and \rul{A-SolvedEVar} follows directly.
\item Case \[\AVar\]
  If $x = y$, then result type is
  $\applye \tctx \tau = \applye {\tctx} {\applye \tctx \tau}$
  by Lemma~\ref{lemma:\ContextApplicationIsIdempotentName}.
  Otherwise the result is the same.
\item The rest cases follows directly from the hypothesis.
\end{itemize}
\qed


\begin{definition}[Typing Size], The size of typing derivation
  $\tctx \byinf \sigma \infto \tau$,
  defined based on typing process in Figure~\ref{},
  written as $\sizet {\tctx \byinf \sigma \infto \tau}$,
  is defined as:
  \begin{center}
  \begin{tabular}{rll}
    $\sizet {\tctx \byinf \star \infto \star}$ & = & 1 \\
    $\sizet {\tctx \byinf x \infto \applye \tctx \sigma}$ & = & 1 \\
    $\sizet {\tctx \byinf \genA \infto \star}$ & = & 1 if $\genA \in \tctx$\\
    $\sizet {\tctx \byinf \genA \infto \star}$ & = & $1 + \sizet{\tctx_1 \byinf \tau \infto \star}$ if $\tctx = \tctx_1, \genA = \tau, \tctx2$\\
    $\sizet {\tctx \byinf \blam x {\sigma_1} e \infto \bpi x {\applye {\tctx} {\sigma_1}} {\sigma_2}}$
                                               & = &
                                                     $1 + \sizet{\tctx \byinf \sigma_1 \infto \star}
                                                     + \sizet{\tctx, x : \sigma_1 \byinf e \infto \sigma_2}$  \\
    $\sizet{\tctx \byinf \bpi x {\sigma_1} {\sigma_2} \infto \star}$
                                               & = &
                                                     $1 + \sizet{\tctx \byinf \sigma_1 \infto \star}
                                                     + \sizet{\tctx, x : \sigma_1 \byinf \sigma_2 \infto \star}
                                                     $\\
    $\sizet{\tctx \byinf \castdn e \infto \sigma_2}$
                                               & = &
                                                     $1 + \sizet{\tctx \byinf e \infto \sigma_1}$ \\
    $\sizet{\tctx \byinf \castup e \infto \applye {\tctx} {\sigma_1}}$
                                               & = &
                                                     $1 + \sizet {\tctx \byinf e \infto \sigma_2} $
  \end{tabular}
  \end{center}
\end{definition}

\begin{lemma}[\ContextApplicationPreservesTypingName]
  \label{lemma:\ContextApplicationPreservesTypingName}
  \ContextApplicationPreservesTypingBody
\end{lemma}
\proof
By induction on the typing size.

\begin{itemize}
  \item Case \[\AAx\]
    \begin{longtable}[l]{lll}
      & $ \applye \tctx \star = \star$ & Directly from the definition of context
      application\\
      & $ \tctx \byinf \star \infto \star$ & By \rul{A-Ax}
    \end{longtable}
  \item Case \rul{AVar}, \rul{AEVar} are similar as \rul{AAx}, which follows
    from definition directly.
  \item Case \[\ASolvedEVar\]
    \begin{longtable}[l]{lll}
      & let $\tctx = \tctx_1, \genA = \tau, \tctx_2$& \\
      & $\applye \tctx \genA = \applye {\tctx_1} \tau$& Follows from definition of context
      application\\
      & $\tctx_1 \byinf \applye {\tctx_1} \tau \infto \star$& By hypothesis\\
      & $\tctx_1, \genA = \tau, \tctx_2 \byinf \applye {\tctx_1} \tau \infto
      \star$ & By Lemma~\ref{lemma:\TypingWeakeningName} \\
    \end{longtable}
  \item Case \[\ALamAnn\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx {\blam x {\sigma_1} e} = \blam x {\applye \tctx
        {\sigma_1}} {\applye \tctx e} $ & Follows from definition of context application \\
      & $\tctx \byinf \applye \tctx {\sigma_1} \infto \star$ & By hypothesis \\
      & $\tctx, x : \sigma_1 \byinf \applye {\tctx, x: \sigma_1} e \infto \sigma_2$ & By hypothesis \\
      & $\tctx, x : \sigma_1 \byinf \applye {\tctx} e \infto \sigma_2$ & By
      definition of context application \\
      & $\tctx, x : \applye \tctx {\sigma_1} \byinf \applye {\tctx} e \infto
      \sigma_2$ & By Lemma~\ref{lemma:\ContextApplicationInContextName}\\
    \end{longtable}

  \item Case \[\APi\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx {\bpi x {\sigma_1} {\sigma_2}} = \bpi x {\applye \tctx
        {\sigma_1}} {\applye \tctx {\sigma_2}} $ & Follows from definition of context application \\
      & $\tctx \byinf \applye \tctx {\sigma_1} \infto \star$ & By hypothesis \\
      & $\tctx, x : \sigma_1 \byinf \applye {\tctx, x: \sigma_1} {\sigma_2} \infto \star$ & By hypothesis \\
      & $\tctx, x : \sigma_1 \byinf \applye {\tctx} {\sigma_2} \infto \star$ & By
      definition of context application \\
      & $\tctx, x : \applye \tctx {\sigma_1} \byinf \applye {\tctx} {\sigma_2}
      \infto \star$ & By Lemma~\ref{lemma:\ContextApplicationInContextName}\\
    \end{longtable}
  \item Case \rul{A-App}, \rul{A-CastDn}, \rul{A-CastUp} follows directly from
    the hypothesis.
\end{itemize}
\qed

\subsection{Properties of Declarative Typing}

\begin{lemma}[\TypingContextWellFormednessName]
  \label{lemma:\TypingContextWellFormednessName}
  \TypingContextWellFormednessBody
\end{lemma}
\proof

By a straightforward induction on the typing derivation.

\qed

\begin{lemma}[\TypingWeakeningName]
  \label{lemma:\TypingWeakeningName}
  \TypingWeakeningBody
\end{lemma}
\proof

By induction on the typing derivation.
\begin{itemize}
  \item Case \rul{A-Ax}, \rul{A-Var}, \rul{A-EVar} and \rul{A-SolvedEVar}
    follows directly.
  \item Case \[\ALamAnn\]
    \begin{longtable}[l]{lll}
      &$\tctx_1, \ctxl, \tctx_2 \byinf \sigma_1 \infto \star$ & By hypothesis\\
      &$\tctx_1, \ctxl, \tctx_2, x:\sigma_1 \wc$& Follows from the definition of
      context well formedness\\
      &$\tctx_1, \ctxl, \tctx_2, x: \sigma_1 \byinf e \infto \sigma_2$& By
      hypothesis
    \end{longtable}
  \item Case \rul{A-Pi} is similar as \rul{A-LamAnn}.
    \item Case \rul{A-App}, \rul{A-CastDn} and \rul{A-CastUp} follows directly
      from hypothesis.
\end{itemize}
\qed

\begin{lemma}[\TypingStrengtheningName]
  \label{lemma:\TypingStrengtheningName}
  \TypingStrengtheningBody
\end{lemma}
\proof

By induction on the typing derivation.

\begin{itemize}
\item Case \rul{A-Ax}
  Follows trivially.
\item Case \[\AVar\]
  \begin{longtable}[l]{lll}
    & $\tctx_1, \tctx_3 \bywt x$ & Given \\
    & $x:\sigma \in \tctx_1, \tctx_3$ & By inversion \\
    & $\tctx_1, \tctx_3 \byinf x \infto \applye {\tctx_1, \tctx_3} \sigma$
    & By \rul{A-Var} \\
    & $\tctx_1, \tctx_3 \wc$ & Given \\
    & $\tctx_1, \tctx_3$ & does not contain any existential variable in $\tctx_2$ \\
    & $\applye {\tctx_1, \tctx_3} \sigma = \applye {\tctx_1, \tctx_2, \tctx_3}
    \sigma $
    & Follows directly
  \end{longtable}
\item \[\AEVar\]
  \begin{longtable}[l]{lll}
    & $\tctx_1, \tctx_3 \bywt \genA$ & Given \\
    & $\genA \in \tctx_1, \tctx_3$ & By inversion \\
    & $\tctx_1, \tctx_3 \byinf \genA \infto \star$
    & By \rul{A-EVar} \\
  \end{longtable}
\item \[\ASolvedEVar\]
  \begin{longtable}[l]{lll}
    & $\tctx_1, \tctx_3 \bywt \genA$ & Given \\
    & $\genA = \tau \in \tctx_1, \tctx_3$ & By inversion \\
    & $\tctx_1, \tctx_3 \byinf \genA \infto \star$
    & By \rul{A-EVar} \\
  \end{longtable}
\item \[\ALamAnn\]
  \begin{longtable}[l]{lll}
    & $\tctx_1, \tctx_3 \bywt \sigma_1$ & Given \\
    & $\tctx_1, \tctx_3 \byinf \sigma_1 \infto \star $
    & By induction hypothesis \\
    & $\tctx_1, \tctx_3, x : \sigma_1 \wc $
    & By \rul{AC-Var} \\
    & $\tctx_1, \tctx_3, x: \sigma_1 \bywt e$ & Given \\
    & $\tctx_1, \tctx_3, x: \sigma_1 \byinf e \infto \sigma_2 $
    & By induction hypothesis \\
    & $\tctx_1, \tctx_3 \byinf \blam x {\sigma_1} e \infto
    \bpi x {\applye {\tctx_1, \tctx_3} {\sigma_1}} \sigma_2 $
    & By \rul{A-LamAnn} \\
    & $\tctx_1, \tctx_3 \wc$ & Given \\
    & $\tctx_1, \tctx_3$ & does not contain any existential variable in $\tctx_2$ \\
    & $\applye {\tctx_1, \tctx_3} {\sigma_1}
    = \applye {\tctx_1, \tctx_2, \tctx_3} {\sigma_1} $
    & Follows directly
  \end{longtable}
\item \[\APi\]
  Similar as Case \rul{A-LamAnn}.
\item \[\AApp\]
  \begin{longtable}[l]{lll}
    & $\tctx_1, \tctx_3 \bywt e_1$ & Given \\
    & $\tctx_1, \tctx_3 \byinf e_1 \infto \bpi x {\sigma_1} {\sigma_2} $
    & By induction hypothesis \\
    & $\tctx_1, \tctx_3 \bywt e_2$ & Given \\
    & $\tctx_1, \tctx_3 \byinf e_2 \infto {\sigma_1} $
    & By induction hypothesis \\
    & $\tctx_1, \tctx_3 \byinf e_1 ~ e_2 \infto
    {\sigma_2 \subst x {\applye {\tctx_1, \tctx_3} {e_1}}} $
    & By \rul{A-App} \\
    & $\tctx_1, \tctx_3 \bywt e_1$ & Given \\
    & $\tctx_1, \tctx_3 \wc$ & Given \\
    & $\tctx_1, \tctx_3, e_1$ & does not contain any existential variable in $\tctx_2$ \\
    & $\applye {\tctx_1, \tctx_3} {e_1}
    = \applye {\tctx_1, \tctx_2, \tctx_3} {\sigma_1} $
    & Follows directly
  \end{longtable}
\item \[\ACastDn\]
  \begin{longtable}[l]{lll}
    & $\tctx_1, \tctx_3 \bywt e$ & Given \\
    & $\tctx_1, \tctx_3 \byinf e \infto \sigma_1 $
    & By induction hypothesis \\
    & $\sigma_1 \redto \sigma_2$
    & Given \\
    & $\tctx_1, \tctx_3 \byinf \castdn e \infto {\sigma_2} $
    & By \rul{A-CastDn}
  \end{longtable}
\item \[\ACastUp\]
  Similar as Case \rul{A-CastDn}.
\end{itemize}
\qed

\begin{lemma}[\TypingVariableExchangeName]
  \label{lemma:\TypingVariableExchangeName}
  \TypingVariableExchangeBody
\end{lemma}
\proof

By straightforward induction on the typing derivation.

\qed

\begin{lemma}[\TypingSubstitutionName]
  \label{lemma:\TypingSubstitutionName}
  \TypingSubstitutionBody
\end{lemma}
\proof

By induction on the size of second typing derivation.

\begin{itemize}
  \item Case \rul{A-Ax}, \rul{A-EVar} and \rul{A-SolvedEVar} follows from typing
    rules directly.
  \item Case \[\AVar\]
    If two $x$'s are the same, then $\sigma_2 = \applye \tctx {\sigma_1}$. The
    goal follows directly from given conditions. If two variables are not the
    same, then it follows directly from \rul{A-Var}.
  \item Case \[\ALamAnn\]
    Let the expression be $\blam y {\sigma'} e$ to avoid name conflicts.
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \sigma' \subst x \tau \infto \star$ & By induction hypothesis \\
      & $\tctx, x:\sigma_1, y: \sigma' \subst x \tau \byinf e \infto \sigma_3$ & Given, notice
      we use $\sigma_3$ to avoid name conflicts \\
      & $\tctx \byinf \sigma_1 \infto \star$ & Given \\
      & $\tctx, y: \sigma' \subst x \tau \byinf \sigma_1 \infto \star$ & By
      Lemma~\ref{lemma:\TypingWeakeningName}\\
      & $\tctx, y: \sigma' \subst x \tau, x:\sigma_1 \wc$ & By \rul{AC-Var} \\
      & $\tctx, y: \sigma' \subst x \tau, x:\sigma_1 \byinf e \infto \sigma_3$ &
      By Lemma~\ref{lemma:\TypingVariableExchangeName} \\
      & $\tctx \byinf \tau \infto \applye \tctx {\sigma_1}$ & Given \\
      & $\tctx, y: \sigma_1 \subst x \tau \byinf \tau \infto \applye \tctx
      {\sigma_1}$ & By Lemma~\ref{lemma:\TypingWeakeningName}  \\
      & $\tctx, y: \sigma_1 \subst x \tau \byinf e \subst x \tau \infto
      \sigma_3$ & By induction hypothesis \\
    \end{longtable}
  \item Case \rul{A-Pi} is similar as \rul{A-LamAnn}.
  \item Rest cases follow directly from hypothesis.
\end{itemize}
\qed

\subsection{Properties of Context Extension}

\begin{lemma}[\DeclarationPreservationName]
  \label{lemma:\DeclarationPreservationName}
  \DeclarationPreservationBody
\end{lemma}
\proof

By a straightforward induction on the context application.

\qed

\begin{lemma}[\ReverseDeclarationPreservationName]
  \label{lemma:\ReverseDeclarationPreservationName}
  \ReverseDeclarationPreservationBody
\end{lemma}
\proof

By a straightforward induction on the context application.

\qed


\begin{lemma}[\DeclarationOrderPreservationName]
  \label{lemma:\DeclarationOrderPreservationName}
  \DeclarationOrderPreservationBody
\end{lemma}
\proof

By induction on the context application.
\begin{itemize}
  \item Case \[\CEEmpty\]
    Impossible case.
  \item Case \[\CEVar\]
    \begin{itemize}
    \item SubCase $v = x$.
      \begin{longtable}[l]{lll}
        & $u \in \tctx$ & Given \\
        & $u \in \ctxr$ & By Lemma~\ref{lemma:\DeclarationPreservationName} \\
        & So $u$ is to the left of $x$ in $\tctx, x$ &
      \end{longtable}
    \item SubCase $v \neq x$.
      \begin{longtable}[l]{lll}
        & $u$ is declared to the left of $v$ in $\tctx$ & Given \\
        & $u$ is declared to the left of $v$ in $\ctxr$ & By induction hypothesis \\
        & $u$ is declared to the left of $v$ in $\ctxr, x: \sigma$ &
      \end{longtable}
    \end{itemize}
  \item Case \rul{CE-EVar}, \rul{CE-SolvedEVar}, \rul{CE-Solve} are
    similar as Case \rul{CE-Var}.
  \item Case \[\CEAdd\]
      \begin{longtable}[l]{lll}
        & $u$ is declared to the left of $v$ in $\ctxr$ & By induction
        hypothesis \\
        & So $u$ is declared to the left of $v$ in $\ctxr, \genA$ &
      \end{longtable}
  \item Case \[\CEAddSolved\]
      \begin{longtable}[l]{lll}
        & $u$ is declared to the left of $v$ in $\ctxr$ & By induction
        hypothesis \\
        & So $u$ is declared to the left of $v$ in $\ctxr, \genA = \tau$ &
      \end{longtable}
\end{itemize}
\qed

\begin{lemma}[\ReverseDeclarationOrderPreservationName]
  \label{lemma:\ReverseDeclarationOrderPreservationName}
  \ReverseDeclarationOrderPreservationBody
\end{lemma}
\proof

We can prove this lemma by contradiction. Suppose $u$ is declared to the right
of $v$ in $\tctx$, then by Lemma~\ref{lemma:\DeclarationOrderPreservationName},
we have that $u$ is declared to the right of $v$ in $\tctx$. Because we already
have $u$ is declared to the left of $v$, we have a contradiction. Therefore, $u$
is declared to the left of $v$ in $\tctx$.

\qed

\begin{lemma}[\SubstitutionExtensionInvarianceName]
  \label{lemma:\SubstitutionExtensionInvarianceName}
  \SubstitutionExtensionInvarianceBody
\end{lemma}

\proof

We first prove $\applye \ctxr \sigma = \applye \tctx {\applye \ctxr \sigma}$,
then prove $\applye \ctxr \sigma = \applye \ctxr {\applye \tctx \sigma}$.

\begin{description}
\item [Part 1]
  We do induction on the context extension.
  \begin{itemize}
    \item Case \[\CEEmpty\]
      Trivial case.
    \item Case \[\CEVar\]
      We use $\sigma_1$ to replace the $\sigma$ in \rul{CE-Var}.
      \begin{longtable}[l]{lll}
        & $\applye {\ctxr, x: \sigma_1} \sigma $ & \\
        & $= \applye \ctxr \sigma$ & Follows by definition of context application
        \\
        & $= \applye \tctx {\applye \ctxr \sigma}$ & By induction hypothesis \\
        & $= \applye {\tctx, x: \sigma_1} {\applye {\ctxr, x: \sigma_1} \sigma}$& By definition of context application
      \end{longtable}
    \item Case \[\CEEVar\]
      Similar as Case \rul{CE-Var}.
    \item Case \[\CESolvedEVar\]
      \begin{longtable}[l]{lll}
        & $\applye {\ctxr, \genA = \tau} \sigma $ & \\
        & $ = \applye {\ctxr} {\sigma \subst \genA \tau} $ & By definition of
        context application \\
        & $ = \applye \tctx {\applye {\ctxr} {\sigma \subst \genA \tau}} $ & By
        induction hypothesis \\
        & $ = \applye {\tctx, \genA = \tau} {\applye {\ctxr} {\sigma \subst \genA \tau}}$ & $\genA \notin FV(\applye \ctxr {\sigma \subst \genA \tau})$ \\
        & $ = \applye {\tctx, \genA = \tau} {\applye {\ctxr, \genA = \tau}
          \sigma}$ & By definition of context application
      \end{longtable}
    \item Case \[\CESolve\]
      \begin{longtable}[l]{lll}
        & $\applye {\ctxr, \genA = \tau} \sigma $ & \\
        & $ = \applye {\ctxr} {\sigma \subst \genA \tau} $ & By definition of
        context application \\
        & $ = \applye \tctx {\applye {\ctxr} {\sigma \subst \genA \tau}} $ & By
        induction hypothesis \\
        & $ = \applye {\tctx, \genA} {\applye {\ctxr} {\sigma \subst \genA
            \tau}} $ & By definition of context application\\
        & $ = \applye {\tctx, \genA} {\applye {\ctxr, \genA = \tau} {\sigma}} $
        & By definition of context application
      \end{longtable}
    \item Case \[\CEAdd\]
      \begin{longtable}[l]{lll}
        & $\applye {\ctxr, \genA} \sigma $ & \\
        & $ = \applye {\ctxr} \sigma $ & By definition of
        context application \\
        & $ = \applye \tctx {\applye {\ctxr} \sigma} $ & By
        induction hypothesis \\
        & $ = \applye \tctx {\applye {\ctxr, \genA} \sigma} $ & By definition of
        context application
      \end{longtable}
    \item Case \[\CEAddSolved\]
      \begin{longtable}[l]{lll}
        & $\applye {\ctxr, \genA = \tau} \sigma $ & \\
        & $ = \applye {\ctxr} {\sigma \subst \genA \tau} $ & By definition of
        context application \\
        & $ = \applye \tctx {\applye {\ctxr} {\sigma \subst \genA \tau}} $ & By
        induction hypothesis \\
        & $ = \applye \tctx {\applye {\ctxr, \genA = \tau} \sigma} $ & By
        definition of context application
      \end{longtable}
  \end{itemize}


\item [Part 2]
  By induction on the size of the typing derivation.

  \begin{itemize}
  \item Case \[\AAx\]
    Follows directly by for all context $\tctx$, $\applye \tctx \star = \star$.
  \item Case \[\AVar\]
    Follows directly by for all context $\tctx$, $\applye \tctx x = x$.
  \item Case \[\AEVar\]
    \begin{longtable}[l]{lll}
      & $\applye \tctx \genA = \genA$& \\
      & $\applye \ctxr {\applye \tctx \genA} = \applye \ctxr \genA$ & Follows
      directly \\
    \end{longtable}
  \item Case \[\ASolvedEVar\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \ctxr$ & Given \\
      & $\genA = \tau \in \tctx$ & Given \\
      & $\ctxr = \ctxr_1, \genA = \tau, \ctxr_2$ & By inversion \\
      & $\applye \ctxr \genA$ & \\
      & $= \applye \ctxr \tau$ & By definition of context application \\
      & $= \applye \ctxr {\applye \tctx \tau}$ & By induction hypothesis \\
      & $= \applye \ctxr {\applye \tctx \genA}$ & By definition of context application
    \end{longtable}
  \item Case \[\ALamAnn\]
    \begin{longtable}[l]{lll}
      & $\applye \ctxr {\sigma} = \applye \ctxr {\applye \tctx {\sigma_1}}$& By
      induction hypothesis \\
      & $\tctx \exto \ctxr$ & Given \\
      & $\tctx, x: \sigma_1 \exto \ctxr, x : \sigma_1 $ & By \rul{CE-Var}\\
      & $\applye {\ctxr, x: \sigma_1} e = \applye {\ctxr, x: \sigma_1} {\applye
        {\tctx, x: \sigma_1} e}$ & By induction hypothesis \\
      & $\applye \ctxr e = \applye \ctxr {\applye \tctx e}$ & By definition of
      context application \\
    \end{longtable}
  \item Case \[\APi\]
    Similar as Case \rul{A-LamAnn}.
  \item Case \[\AApp\]
    Follows directly from induction hypothesis.
  \item Case \[\ACastDn\]
    Follows directly from induction hypothesis.
  \item Case \[\ACastUp\]
    Follows directly from induction hypothesis.
\end{itemize}
\end{description}

\qed

\begin{lemma}[\ExtensionEqualityPreservationName]
  \label{lemma:\ExtensionEqualityPreservationName}
  \ExtensionEqualityPreservationBody
\end{lemma}

\proof

\mbox{} % an empty line to make sure long table appear after proof
\begin{longtable}[l]{lll}
  & $\applye \ctxr {\sigma_1}$ & \\
  & $= \applye \ctxr {\applye \tctx {\sigma_1}}$& By
  Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName}\\
  & $= \applye \ctxr {\applye \tctx {\sigma_2}}$ & Given \\
  & $= \applye \ctxr {\sigma_2}$ & By
  Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName}
\end{longtable}

\qed

\begin{lemma}[\ContextExtensionReflexivityName]
  \label{lemma:\ContextExtensionReflexivityName}
  \ContextExtensionReflexivityBody
\end{lemma}

\proof

By induction on the well-formedness of context.

\begin{itemize}
  \item Case \[\ACEmpty\]
    Follows directly from \rul{CE-Empty}.
  \item Case \[\ACVar\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \tctx$ & By induction hypothesis \\
      & $\tctx, x : \sigma \exto \tctx, x : \sigma$ & By \rul{CE-Var}
    \end{longtable}
  \item Case \[\ACEVar\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \tctx$ & By induction hypothesis \\
      & $\genA \notin \tctx$ & Given \\
      & $\tctx, \genA \exto \tctx, \genA$ & By \rul{CE-EVar}
    \end{longtable}
  \item Case \[\ACSolvedEVar\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \tctx$ & By induction hypothesis \\
      & $\genA \notin \tctx$ & Given \\
      & $\tctx, \genA = \tau \exto \tctx, \genA = \tau$ & By \rul{CE-SolvedEVar}
    \end{longtable}
\end{itemize}

\qed

\begin{lemma}[\ContextExtensionTransitivityName]
  \label{lemma:\ContextExtensionTransitivityName}
  \ContextExtensionTransitivityBody
\end{lemma}

\proof

By induction on the derivation $\tctx \exto \ctxr$.

\begin{itemize}
  \item Case \[\CEEmpty\]
    Our goal $\ctxl \exto \ctxinit $ is given.
  \item Case \[\CEVar\]
    \begin{longtable}[l]{lll}
      & $\ctxl \exto \tctx, x: \sigma$ & Given \\
      & $\ctxl = \ctxl', x: \sigma$ & By inversion \\
      & $\ctxl' \exto \tctx$ & By inversion \\
      & $\ctxl' \exto \ctxr$ & By induction hypothesis \\
      & $\ctxl', x: \sigma \exto \ctxr, x: \sigma$ & By \rul{CE-Var} \\
      & $\ctxl \exto \ctxr, x: \sigma$ & Namely
    \end{longtable}
  \item Case \[\CEEVar\]
    We are given $\ctxl \exto \tctx, \genA$.
    By inversion, we have two subcases.
    \begin{itemize}
    \item SubCase  \[ \inferrule{
            \ctxl \exto \tctx
         \\ \genA \notin \tctx
            }{
            \ctxl, \genA \exto \tctx, \genA
            }\rname{CE-EVar}\]
      \begin{longtable}[l]{lll}
        & $\ctxl \exto \tctx$ & Given\\
        & $\ctxl \exto \ctxr$ & By induction hypothesis \\
        & $\ctxl, \genA \exto \ctxr, \genA$ & By \rul{CE-EVar} \\
      \end{longtable}
    \item SubCase \[\inferrule{
            \ctxl \exto \tctx
         \\ \genA \notin \tctx
            }{
            \ctxl \exto \tctx, \genA
            }\rname{CE-Add}\]
      \begin{longtable}[l]{lll}
        & $\ctxl \exto \tctx$ & Given\\
        & $\ctxl \exto \ctxr$ & By induction hypothesis \\
        & $\ctxl \exto \ctxr, \genA$ & By \rul{CE-Add} \\
      \end{longtable}
    \end{itemize}
  \item Case \[\CESolvedEVar\]
    We are given $\ctxl \exto \tctx, \genA= \tau$.
    By inversion, we have three subcases.
    \begin{itemize}
    \item SubCase \[\inferrule{
            \ctxl \exto \tctx
         \\ \genA \notin \tctx
            }{
            \ctxl, \genA = \tau \exto \tctx, \genA = \tau
            }\rname{CE-SolvedEVar} \]
      \begin{longtable}[l]{lll}
        & $\ctxl \exto \ctxr$ & By induction hypothesis \\
        & $\ctxl, \genA = \tau \exto \ctxr, \genA = \tau$ & By \rul{CE-SolvedEVar} \\
      \end{longtable}
    \item SubCase \[\inferrule{
            \ctxl \exto \tctx
         \\ \genA \notin \tctx
         \\ \tctx \bywf \tau
            }{
            \ctxl, \genA \exto \tctx, \genA = \tau
            }\rname{CE-Solve} \]
          \begin{longtable}[l]{lll}
            & $\ctxl \exto \tctx$ & Given \\
            & $\ctxl \exto \ctxr$ & By induction hypothesis \\
            & $\tctx \bywf \tau$ & Given \\
            & $\tctx \wc$ & By
            Lemma~\ref{lemma:\TypingContextWellFormednessName} \\
            & $\ctxr \wc$ & By
            Lemma~\ref{lemma:\ContextExtensionPreservesContextWellFormednessName}\\
            & $\ctxr \bywf \tau$ & By
            Corollary~\ref{lemma:\ExtensionWeakningWellFormednessName} \\
            & $\ctxl \exto \ctxr, \genA = \tau$ & By \rul{CE-AddSolved} \\
          \end{longtable}
    \end{itemize}
  \item Case \[\CESolve\]
    We are given $\ctxl \exto \tctx, \genA$.
    By induction, we have two subcases.
    \begin{itemize}
    \item SubCase \[\inferrule{
            \ctxl \exto \tctx
         \\ \genA \notin \tctx
            }{
            \ctxl, \genA \exto \tctx, \genA
            }\rname{CE-EVar} \]
      \begin{longtable}[l]{lll}
        & $\ctxl \exto \tctx$ & Given \\
        & $\ctxl \exto \ctxr$ & By induction hypothesis \\
        & $\ctxl, \genA \exto \ctxr, \genA = \tau$ & By \rul{CE-Solve} \\
      \end{longtable}
    \item SubCase \[\inferrule{
            \ctxl \exto \tctx
         \\ \genA \notin \tctx
            }{
            \ctxl \exto \tctx, \genA
            }\rname{CE-Add} \]
      \begin{longtable}[l]{lll}
        & $\ctxl \exto \tctx$ & Given \\
        & $\ctxl \exto \ctxr$ & By induction hypothesis \\
        & $\ctxl \exto \ctxr, \genA = \tau$ & By \rul{CE-AddSolved} \\
      \end{longtable}
    \end{itemize}
  \item Case \[\CEAdd\]
    \begin{longtable}[l]{lll}
      & $\ctxl \exto \tctx$ & Given \\
      & $\ctxl \exto \ctxr$ & By induction hypothesis \\
      & $\ctxl \exto \ctxr, \genA$ & By \rul{CE-Add} \\
    \end{longtable}
  \item Case \[\CEAddSolved\]
    \begin{longtable}[l]{lll}
      & $\ctxl \exto \tctx$ & Given \\
      & $\ctxl \exto \ctxr$ & By induction hypothesis \\
      & $\ctxl \exto \ctxr, \genA = \tau$ & By \rul{CE-Add} \\
    \end{longtable}
\end{itemize}

\qed

\begin{definition}[Softness]
  A Context $\tctx$ is soft if and only if it consists only of $\genA$ and
  $\genA = \tau$ declarations.
\end{definition}

\begin{lemma}[\RightSoftnessName]
  \label{lemma:\RightSoftnessName}
  \RightSoftnessBody
\end{lemma}

\proof

By induction on $\ctxl$, and apply rule \rul{CE-Add} and \rul{CE-AddSolved} as needed.

\qed

\begin{lemma}[\ExtensionOrderName]\leavevmode
  \label{lemma:\ExtensionOrderName}
  \ExtensionOrderBody
\end{lemma}

\proof

\begin{description}
\item [Part 1]
  By induction on the context extension $\tctx_L, y : \sigma, \tctx_R \exto
  \ctxr$.
  \begin{itemize}
    \item Case \[\CEEmpty\]
      Impossible case.
    \item Case \[\CEVar\]
      Depending on whether $x = y$, we have two subcases.
      \begin{itemize}
        \item SubCase $x = y$.
          Therefore $\tctx_R = \ctxr_R = \ctxinit$,
          and $\tctx_L = \tctx, \ctxr_L = \ctxr$.
          All goal follows directly.
        \item SubCase $x \neq y$.
          Then we have
          \[\inferrule{
            \tctx, y:\sigma, \tctx_R' \exto \ctxr
            }{
            \tctx, y:\sigma, \tctx_R', x:\sigma \exto \ctxr, x:\sigma
            }\rname{CE-Var}
          \]
          \begin{longtable}[l]{lll}
            & $\ctxr = \ctxr_L, y:\sigma, \ctxr_R'$ & By induction hypothesis \\
            & $\tctx_L \exto \ctxr_L$ & By induction hypothesis\\
            & $\tctx_R', x: \sigma$ & is not soft\\
            & $\ctxr_R', x: \sigma$ & is not soft
          \end{longtable}
        \end{itemize}
      \item Case \[\inferrule{
            \tctx_L, y: \sigma, \tctx_R' \exto \ctxr
            \\ \genA \notin \ctxr
          }{
            \tctx_L, y:\sigma, \tctx_R', \genA \exto \ctxr, \genA
          }\rname{CE-EVar} \]
        \begin{longtable}[l]{lll}
          & $\ctxr = \ctxr_L, y:\sigma, \ctxr_R'$ & By induction hypothesis \\
          & $\tctx_L \exto \ctxr_L$ & By induction hypothesis\\
          & $\tctx_R'$ is soft  iff $\ctxr_R'$ is soft & By induction
          hypothesis \\
          & $\tctx_R', \genA $ is soft  iff $\ctxr_R', \genA$ is soft &
          Follows directly
        \end{longtable}
      \item Case \[\inferrule{
            \tctx_L, y: \sigma, \tctx_R' \exto \ctxr
         \\ \genA \notin \ctxr
            }{
            \tctx_L, y:\sigma, \tctx_R', \genA = \tau \exto \ctxr, \genA = \tau
            }\rname{CE-SolvedEVar}\]
        \begin{longtable}[l]{lll}
          & $\ctxr = \ctxr_L, y:\sigma, \ctxr_R'$ & By induction hypothesis \\
          & $\tctx_L \exto \ctxr_L$ & By induction hypothesis\\
          & $\tctx_R'$ is soft  iff $\ctxr_R'$ is soft & By induction
          hypothesis \\
          & $\tctx_R', \genA = \tau$ is soft  iff $\ctxr_R', \genA = \tau$ is soft &
          Follows directly
        \end{longtable}
      \item Case \[\inferrule{
            \tctx_L, y: \sigma, \tctx_R' \exto \ctxr
         \\ \genA \notin \ctxr
         \\ \ctxr \bywf \tau
            }{
            \tctx_L, y: \sigma, \tctx_R', \genA \exto \ctxr, \genA = \tau
            }\rname{CE-Solve} \]
        \begin{longtable}[l]{lll}
          & $\ctxr = \ctxr_L, y:\sigma, \ctxr_R'$ & By induction hypothesis \\
          & $\tctx_L \exto \ctxr_L$ & By induction hypothesis\\
          & $\tctx_R'$ is soft  iff $\ctxr_R'$ is soft & By induction
          hypothesis \\
          & $\tctx_R', \genA $ is soft  iff $\ctxr_R', \genA = \tau$ is soft &
          Follows directly
        \end{longtable}
      \item Case \[\inferrule{
            \tctx_L, y:\sigma, \tctx_R \exto \ctxr
         \\ \genA \notin \ctxr
            }{
            \tctx_L, y:\sigma, \tctx_R \exto \ctxr, \genA
            }\rname{CE-Add}
        \]
        \begin{longtable}[l]{lll}
          & $\ctxr = \ctxr_L, y:\sigma, \ctxr_R'$ & By induction hypothesis \\
          & $\tctx_L \exto \ctxr_L$ & By induction hypothesis\\
          & $\tctx_R$ is soft  iff $\ctxr_R'$ is soft & By induction
          hypothesis \\
          & $\tctx_R $ is soft  iff $\ctxr_R', \genA$ is soft &
          Follows directly
        \end{longtable}
      \item Case \[
          \inferrule{
            \tctx_L, y :\sigma, \tctx_R \exto \ctxr
         \\ \genA \notin \ctxr
         \\ \ctxr \bywf \tau
            }{
            \tctx_L, y:\sigma, \tctx_R \exto \ctxr, \genA = \tau
            }\rname{CE-AddSolved} \]
        \begin{longtable}[l]{lll}
          & $\ctxr = \ctxr_L, y:\sigma, \ctxr_R'$ & By induction hypothesis \\
          & $\tctx_L \exto \ctxr_L$ & By induction hypothesis\\
          & $\tctx_R$ is soft  iff $\ctxr_R'$ is soft & By induction
          hypothesis \\
          & $\tctx_R $ is soft  iff $\ctxr_R', \genA = \tau$ is soft &
          Follows directly
        \end{longtable}
  \end{itemize}
  \item [Part 2] Similar to Part 1.
  \item [Part 3] Similar to Part 1.
\end{description}

\qed

\begin{lemma}[\ExtensionWeakningName]
  \label{lemma:\ExtensionWeakningName}
  \ExtensionWeakningBody
\end{lemma}

\proof

By induction on the typing derivation.

\begin{itemize}
\item Case \[\AAx\]
  Follows directly by \rul{A-Ax}.
\item Case \[\AVar\]
  \begin{longtable}[l]{lll}
    & $x : \sigma \in \tctx$ & Given \\
    & $x : \sigma \in \ctxr$ & By Lemma~\ref{lemma:\ExtensionOrderName} \\
    & $\ctxr \byinf x \infto \applye \ctxr \sigma$ & By \rul{A-Var} \\
    & $\tau_2 = \applye \tctx \sigma$ & Given \\
    & $\applye \ctxr \sigma $ & \\
    & $= \applye \ctxr {\applye \tctx \sigma} $ & By
    Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName}\\
    & $= \applye \ctxr {\tau_2} $ & Substitute above equality
  \end{longtable}
\item Case \[\AEVar\]
  By Lemma~\ref{lemma:\ExtensionOrderName},
  we have either $\genA$ or $\genA = \tau$ in $\ctxr$.
  Then by rule \rul{A-EVar} or \rul{A-SolvedEVar}, we have
  $\ctxr \byinf \genA \infto \star$ directly.
\item Case \[\ASolvedEVar\]
  By Lemma~\ref{lemma:\ExtensionOrderName},
  and rule \rul{A-SolveEVar}, we have
  $\ctxr \byinf \genA \infto \star$ directly.
\item Case \[\ALamAnn\]
  \begin{longtable}[l]{lll}
    & $\ctxr \byinf \sigma_1 \infto \star$ & By induction hypothesis \\
    & $\tctx, x: \sigma_1 \exto \ctxr, x: \sigma_1$ & By \rul{CE-Var} \\
    & $\ctxr, x: \sigma_1 \byinf e \infto \applye {\ctxr, x: \sigma_1}
    {\sigma_2}$ & By induction hypothesis \\
    & $\ctxr, x: \sigma_1 \byinf e \infto \applye \ctxr
    {\sigma_2}$ & By definition of context substitution \\
    & $\ctxr \byinf \blam x {\sigma_1} e \infto \bpi x {\applye \ctxr {\sigma_1}}
    {\applye \ctxr {\sigma_2}}$& By \rul{A-LamAnn} \\
    & $\applye \ctxr {\sigma_1} = \applye \ctxr {\applye \tctx {\sigma_1}}$ & By
    Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
    & $\ctxr \byinf \blam x {\sigma_1} e \infto \bpi x {\applye \ctxr {\applye
        \tctx {\sigma_1}}}
    {\applye \ctxr {\sigma_2}}$& Substitute above equality \\
    & $\ctxr \byinf \blam x {\sigma_1} e \infto \applye \ctxr {\bpi x {\applye
        \tctx {\sigma_1}} {\sigma_2}}$& Follows directly
  \end{longtable}
\item Case \[\APi\]
  \begin{longtable}[l]{lll}
    & $\ctxr \byinf \sigma_1 \infto \star$ & By induction hypothesis \\
    & $\tctx, x: \sigma_1 \exto \ctxr, x: \sigma_1$ & By \rul{CE-Var} \\
    & $\ctxr, x: \sigma_1 \byinf \sigma_2 \infto \star$ & By induction
    hypothesis \\
    & $\ctxr \byinf \bpi x {\sigma_1} {\sigma_2} \infto \star$ & By \rul{A-Pi}
  \end{longtable}
\item Case \[\AApp\]
  \begin{longtable}[l]{lll}
    & $\ctxr \byinf e_1 \infto \applye \ctxr {\bpi x {\sigma_1} {\sigma_2}}$ &
    By induction hypothesis \\
    & $\ctxr \byinf e_1 \infto {\bpi x {\applye \ctxr {\sigma_1}} {\applye \ctxr
        {\sigma_2}}}$ &
    Follows directly \\
    & $\ctxr \byinf e_2 \infto \applye \ctxr {\sigma_1}$ &
    By induction hypothesis \\
    & $\ctxr \byinf e_1 ~ e_2 \infto
    (\applye \ctxr {\sigma_2}) \subst x {\applye \ctxr {e_1}}$ &
    By \rul{A-App} \\
    & $(\applye \ctxr {\sigma_2}) \subst x {\applye \ctxr {e_1}}$ & \\
    & $ = (\applye \ctxr {\sigma_2}) \subst x {\applye \ctxr {\applye \tctx
        {e_1}}}$ & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName}\\
    & $ = \applye \ctxr {\sigma_2 \subst x {\applye \tctx {e_1}}}$ & Property of
    substitution \\
  \end{longtable}
\item Case \[\ACastDn\]
  \begin{longtable}[l]{lll}
    & $\ctxr \byinf e \infto \applye \ctxr {\sigma_1}$& By induction
    hypothesis \\
    & $\applye \ctxr {\sigma_1} \redto \applye \ctxr {\sigma_2}$& By
    Lemma~\ref{lemma:\ContextApplicationOverReductionName} \\
    & $\ctxr \byinf \castdn e \infto \applye \ctxr {\sigma_2}$& By \rul{A-CastDn}
  \end{longtable}

\item Case \[\ACastUp\]
  \begin{longtable}[l]{lll}
    & $\ctxr \byinf e \infto \applye \ctxr {\sigma_2}$& By induction
    hypothesis \\
    & $\applye \ctxr {\sigma_1} $ & \\
    & $ = \applye \ctxr {\applye \tctx {\sigma_1}} $ & By
    Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
    & $ \redto \applye \ctxr {\sigma_2}$& By
    Lemma~\ref{lemma:\ContextApplicationOverReductionName} \\
    & $\ctxr \byinf \castup e \infto \applye \ctxr {\sigma_1}$& By \rul{A-CastUp}
  \end{longtable}
\end{itemize}

\qed

\begin{corollary}[\ExtensionWeakningWellFormednessName]
  \label{lemma:\ExtensionWeakningWellFormednessName}
  \ExtensionWeakningWellFormednessBody
\end{corollary}

\proof

Follows directly by Lemma~\ref{lemma:\ExtensionWeakningName} since $\applye
\ctxr \star = \star$.

\qed

\begin{lemma}[\ExtensionWeakeningWellScopednessName]
  \label{lemma:\ExtensionWeakeningWellScopednessName}
  \ExtensionWeakeningWellScopednessBody
\end{lemma}

\proof

By a straightforward induction on the context extension.

\qed

\begin{lemma}[\ContextExtensionPreservesContextWellFormednessName]
  \label{lemma:\ContextExtensionPreservesContextWellFormednessName}
  \ContextExtensionPreservesContextWellFormednessBody
\end{lemma}

\proof

By induction on the context extension.

\begin{itemize}
\item Case \[\CEEmpty\]
  Here we have $\tctx = \ctxr$, so our goal is given.
\item Case \[\CEVar\]
  \begin{longtable}[l]{lll}
    & $\tctx \wc$ & By hypothesis \\
    & $\tctx \bywf \sigma$ & By hypothesis \\
    & $x \notin \tctx$ & By hypothesis \\
    & $\ctxr \wc$& By induction hypothesis \\
    & $\ctxr \bywf \sigma$& By
    Corollary~\ref{lemma:\ExtensionWeakningWellFormednessName} \\
    & $x \notin \ctxr$ & Context extension add no variables\\
    & $\ctxr, x :\sigma \wc$ & By \rul{AC-Var}
  \end{longtable}

\item Case \[\CEEVar\]
  \begin{longtable}[l]{lll}
    & $\tctx \wc$ & By hypothesis \\
    & $\ctxr \wc$& By induction hypothesis \\
    & $\genA \notin \ctxr$ & Given \\
    & $\ctxr, \genA \wc$ & By \rul{AC-EVar}
  \end{longtable}

\item Case \[\CESolvedEVar\]
  \begin{longtable}[l]{lll}
    & $\tctx \wc$ & By hypothesis \\
    & $\tctx \bywf \tau$ & By hypothesis \\
    & $\ctxr \wc$& By induction hypothesis \\
    & $\ctxr \bywf \tau$ & By
    Corollary~\ref{lemma:\ExtensionWeakningWellFormednessName} \\
    & $\ctxr, \genA = \tau$ & By \rul{AC-SolvedEVar}
  \end{longtable}
\item Case \[\CESolve\]
  \begin{longtable}[l]{lll}
    & $\tctx \wc$ & By hypothesis \\
    & $\ctxr \wc$& By induction hypothesis \\
    & $\ctxr, \genA = \tau$ & By \rul{AC-SolvedEVar}
  \end{longtable}
\item Case \[\CEAdd\]
  \begin{longtable}[l]{lll}
    & $\tctx \wc$ & By hypothesis \\
    & $\ctxr \wc$& By induction hypothesis \\
    & $\ctxr, \genA$ & By \rul{AC-EVar}
  \end{longtable}
\item Case \[\CEAddSolved\]
  \begin{longtable}[l]{lll}
    & $\tctx \wc$ & By hypothesis \\
    & $\ctxr \wc$& By induction hypothesis \\
    & $\ctxr, \genA = \tau$ & By \rul{AC-EVar}
  \end{longtable}
\end{itemize}

\qed

\begin{lemma}[\SolutionAdmissibilityForExtensionName]
  \label{lemma:\SolutionAdmissibilityForExtensionName}
  \SolutionAdmissibilityForExtensionBody
\end{lemma}

\proof

By induction on $\tctx_R$.

\begin{itemize}
\item Case $\ctxinit$.
  \begin{longtable}[l]{lll}
    & $\tctx_L \exto \tctx_L $ & By
    Lemma~\ref{lemma:\ContextExtensionReflexivityName} \\
    & $\tctx_L, \genA \exto \tctx_L, \genA = \tau$ & By \rul{CE-Solve}
  \end{longtable}
\item Case $\tctx_R = \tctx_R', x: \sigma$
  \begin{longtable}[l]{lll}
    & $\tctx_L, \genA, \tctx_R' \exto \tctx_L, \genA = \tau, \tctx_R' $ & By
    induction hypothesis \\
    & $\tctx_L, \genA, \tctx_R', x: \sigma \exto \tctx_L, \genA = \tau,
    \tctx_R', x: \sigma $ & By \rul{CE-Var}
  \end{longtable}
\item Case $\tctx_R = \tctx_R', \genB$
  \begin{longtable}[l]{lll}
    & $\tctx_L, \genA, \tctx_R' \exto \tctx_L, \genA = \tau, \tctx_R' $ & By
    induction hypothesis \\
    & $\tctx_L, \genA, \tctx_R', \genB \exto \tctx_L, \genA = \tau,
    \tctx_R', \genB $ & By \rul{CE-EVar}
  \end{longtable}
\item Case $\tctx_R = \tctx_R', \genB = \sigma$
  \begin{longtable}[l]{lll}
    & $\tctx_L, \genA, \tctx_R' \exto \tctx_L, \genA = \tau, \tctx_R' $ & By
    induction hypothesis \\
    & $\tctx_L, \genA, \tctx_R' \byinf \sigma \infto \star$ & Given\\
    & $\tctx_L, \genA = \tau, \tctx_R' \byinf \sigma \infto \star$ & By
    Lemma~\ref{lemma:\ExtensionWeakningName}\\
    & $\tctx_L, \genA, \tctx_R', \genB = \sigma \exto \tctx_L, \genA = \tau,
    \tctx_R', \genB=\sigma $ & By \rul{CE-SolvedEVar}
  \end{longtable}
\end{itemize}
\qed

\begin{lemma}[\UnsolvedVariableAdditionForExtensionName]
  \label{lemma:\UnsolvedVariableAdditionForExtensionName}
  \UnsolvedVariableAdditionForExtensionBody
\end{lemma}

\proof

By induction on $\tctx_R$.

\begin{itemize}
\item Case $\ctxinit$.
  \begin{longtable}[l]{lll}
    & $\tctx_L \exto \tctx_L $ & By
    Lemma~\ref{lemma:\ContextExtensionReflexivityName} \\
    & $\tctx_L \exto \tctx_L, \genA$ & By \rul{CE-Add}
  \end{longtable}
\item Case $\tctx_R = \tctx_R', x: \sigma$
  \begin{longtable}[l]{lll}
    & $\tctx_L, \tctx_R' \exto \tctx_L, \genA, \tctx_R' $ & By
    induction hypothesis \\
    & $\tctx_L, \tctx_R', x: \sigma \exto \tctx_L, \genA,
    \tctx_R', x: \sigma $ & By \rul{CE-Var}
  \end{longtable}
\item Case $\tctx_R = \tctx_R', \genB$
  \begin{longtable}[l]{lll}
    & $\tctx_L, \tctx_R' \exto \tctx_L, \genA, \tctx_R' $ & By
    induction hypothesis \\
    & $\tctx_L, \tctx_R', \genB \exto \tctx_L, \genA,
    \tctx_R', \genB $ & By \rul{CE-EVar}
  \end{longtable}
\item Case $\tctx_R = \tctx_R', \genB = \sigma$
  \begin{longtable}[l]{lll}
    & $\tctx_L, \tctx_R' \exto \tctx_L, \genA, \tctx_R' $ & By
    induction hypothesis \\
    & $\tctx_L, \tctx_R' \byinf \sigma \infto \star$ & Given\\
    & $\tctx_L, \genA , \tctx_R' \byinf \sigma \infto \star$ & By
    Lemma~\ref{lemma:\ExtensionWeakningName}\\
    & $\tctx_L, \tctx_R', \genB = \sigma \exto \tctx_L, \genA,
    \tctx_R', \genB=\sigma $ & By \rul{CE-SolvedEVar}
  \end{longtable}
\end{itemize}
\qed

\begin{lemma}[\SolvedVariableAdditionForExtensionName]
  \label{lemma:\SolvedVariableAdditionForExtensionName}
  \SolvedVariableAdditionForExtensionBody
\end{lemma}

\proof

\mbox{} % an empty line to make sure long table appear after proof
\begin{longtable}[l]{lll}
  & $\tctx_L, \tctx_R \exto \tctx_L, \genA, \tctx_R $ & By
  Lemma~\ref{lemma:\UnsolvedVariableAdditionForExtensionName} \\
  & $\tctx_L, \genA, \tctx_R \exto \tctx_L, \genA = \tau, \tctx_R $ & By
  Lemma~\ref{lemma:\SolutionAdmissibilityForExtensionName} \\
  & $\tctx_L, \tctx_R \exto \tctx_L, \genA = \tau, \tctx_R$ &
  By Lemma~\ref{lemma:\ContextExtensionTransitivityName}
\end{longtable}

\qed

\begin{lemma}[\ParallelAdmissibilityName]\leavevmode
  \label{lemma:\ParallelAdmissibilityName}
  \ParallelAdmissibilityBody
\end{lemma}

\begin{lemma}[\ParallelExtensionSolutionName]\leavevmode
  \label{lemma:\ParallelExtensionSolutionName}
  \ParallelExtensionSolutionBody
\end{lemma}

\begin{lemma}[\StabilityOfCompleteContextsName]
  \label{lemma:\StabilityOfCompleteContextsName}
  \StabilityOfCompleteContextsBody
\end{lemma}

\begin{lemma}[\FinishingTypesName]
  \label{lemma:\FinishingTypesName}
  \FinishingTypesBody
\end{lemma}

\begin{lemma}[\FinishingCompletionsName]
  \label{lemma:\FinishingCompletionsName}
  \FinishingCompletionsBody
\end{lemma}

\begin{lemma}[\ConfluenceOfCompletenessName]
  \label{lemma:\ConfluenceOfCompletenessName}
  \ConfluenceOfCompletenessBody
\end{lemma}

\begin{lemma}[\CompleteContextApplicationExtensionName]
  \label{lemma:\CompleteContextApplicationExtensionName}
  \CompleteContextApplicationExtensionBody
\end{lemma}

\subsection{Properties of Type Sanitization}

\begin{lemma}[\TypeSanitizationExtensionName]
  \label{lemma:\TypeSanitizationExtensionName}
  \TypeSanitizationExtensionBody
\end{lemma}

\proof

By induction on type sanitization.

\begin{itemize}
  \item Case \[\IEVarAfter\]
    \begin{longtable}[l]{lll}
      & $\tctx[\genA][\genB] \exto \tctx[\genA_1, \genA][\genB] $ & By
      Lemma~\ref{lemma:\UnsolvedVariableAdditionForExtensionName} \\
      & $\tctx[\genA_1, \genA][\genB] \exto \tctx[\genA_1, \genA][\genB =
      \genA_1] $ & By
      Lemma~\ref{lemma:\SolutionAdmissibilityForExtensionName} \\
      & $\tctx[\genA][\genB] \exto \tctx[\genA_1, \genA][\genB =
      \genA_1] $ & By
      Lemma~\ref{lemma:\ContextExtensionTransitivityName}
    \end{longtable}
  \item Case \[\IEVarBefore\]
    Follows directly by Lemma~\ref{lemma:\ContextExtensionReflexivityName}.
  \item Case \[\IVar\]
    Follows directly by Lemma~\ref{lemma:\ContextExtensionReflexivityName}.
  \item Case \[\IStar\]
    Follows directly by Lemma~\ref{lemma:\ContextExtensionReflexivityName}.
  \item Case \[\IApp\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \ctxl_1$ & By induction hypothesis \\
      & $\tctx \byinf e_1 ~ e_2 \infto \sigma $ & Given \\
      & $\tctx \byinf e_2 \infto \sigma' $ & By inversion \\
      & $\ctxl_1 \byinf e_2 \infto \applye {\ctxl_1} {\sigma'} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_2} \infto
      {\sigma'} $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1 \exto \ctxl$ & By induction hypothesis \\
      & $\tctx \exto \ctxl $ & By
      Lemma~\ref{lemma:\ContextExtensionTransitivityName}
    \end{longtable}
  \item Case \[\ILamAnn\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \ctxl_1$ & By induction hypothesis \\
      & $\tctx \byinf \blam x {\tau_1} {e_1} \infto \sigma $ & Given \\
      & $\tctx, {x : \tau_1} \byinf {e_1} \infto \sigma' $ & By inversion \\
      & $\tctx, {x : \tau_1} \exto \ctxl_1, x : \tau_1 $ & By \rul{CE-Var} \\
      & $\ctxl_1, {x : \tau_1} \byinf {e_1} \infto \applye {\ctxl_1, x:
        \tau_1} {\sigma'} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1, {x : \tau_1} \byinf \applye {\ctxl_1, x: \tau_1} {e_1} \infto
      {\applye {\ctxl_1, x: \tau_1} {\sigma'}} $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1, {x : \tau_1} \byinf \applye {\ctxl_1} {e_1} \infto
      {\applye {\ctxl_1} {\sigma'}} $
      & By definition of context application \\
      & $\ctxl_1, x: \tau_1 \exto \ctxl, x: \tau_1$ & By induction hypothesis \\
      & $\ctxl_1 \exto \ctxl$ & By inversion \\
      & $\tctx \exto \ctxl $ & By
      Lemma~\ref{lemma:\ContextExtensionTransitivityName}
    \end{longtable}
  \item Case \[\IPi\]
    Similar as Case \rul{I-LamAnn}.
  \item Case \[\ICastDn\]
    Follows directly from induction hypothesis.
  \item Case \[\ICastUp\]
    Follows directly from induction hypothesis.
\end{itemize}

\qed

\begin{lemma}[\TypeSanitizationEquivalenceName]
  \label{lemma:\TypeSanitizationEquivalenceName}
  \TypeSanitizationEquivalenceBody
\end{lemma}

\proof

By induction on type sanitization.

\begin{itemize}
  \item Case \[\IEVarAfter\]
    \begin{longtable}[l]{lll}
      & $\applye {\tctx[\genA_1, \genA][\genB = \genA_1]} {\genB} = \genA_1$ &
      By definition of context substitution \\
      & $\applye {\tctx[\genA_1, \genA][\genB = \genA_1]} {\genA_1} = \genA_1$ &
      By definition of context substitution
    \end{longtable}
  \item Case \[\IEVarBefore\]
    Follows trivially.
  \item Case \[\IVar\]
    Follows trivially.
  \item Case \[\IStar\]
    Follows trivially.
  \item Case \[\IApp\]
    \begin{longtable}[l]{lll}
      & $\applye {\ctxl_1} {e_1} = \applye {\ctxl_1} {e_3}$
      & By induction hypothesis \\
      & $\tctx \byinf e_1 ~ e_2 \infto \sigma $ & Given \\
      & $\tctx \byinf e_1 \infto \sigma' $ & By inversion \\
      & $\tctx \byinf e_2 \infto \sigma'' $ & By inversion \\
      & $\tctx \exto \ctxl_1$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl_1 \byinf e_2 \infto \applye {\ctxl_1} {\sigma''} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_2} \infto
      {\applye {\ctxl_1} {\sigma''}} $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1 \exto \ctxl$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\applye {\ctxl} {\applye {\ctxl_1} {e_2}} = \applye {\ctxl} {e_4}$
      & By induction hypothesis \\
      & $\applye {\ctxl} {e_2} = \applye {\ctxl} {e_4}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\applye \ctxl {e_3} $& \\
      & $= \applye \ctxl {\applye {\ctxl_1} {e_3}} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $= \applye \ctxl {\applye {\ctxl_1} {e_1}} $
      & By above equalities \\
      & $= \applye \ctxl {e_1} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
    \end{longtable}
  \item Case \[\ILamAnn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \blam x {\tau_1} {e_1} \infto \sigma$
      & Given \\
      & $\tctx \byinf \tau_1 \infto \star$
      & By inversion\\
      & $\tctx \exto \ctxl_1$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\applye {\ctxl_1} {\tau_1} = \applye {\ctxl_1} {\tau_2}$
      & By induction hypothesis \\
      & $\tctx, x: \tau_1 \exto \ctxl_1, x : \tau_1$
      & By \rul{CE-Var} \\
      & $\tctx, x:\tau_1 \byinf e_1 \infto \sigma'$
      & By inversion\\
      & $\ctxl_1, x: \tau_1 \byinf e_1 \infto
      \applye {\ctxl_1, x: \tau_1} {\sigma'}$
      & By Lemma~\ref{lemma:\ExtensionWeakningName}\\
      & $\ctxl_1, x: \tau_1 \byinf \applye {\ctxl_1, x: \tau_1} {e_1} \infto
      \applye {\ctxl_1, x: \tau_1} {\sigma'}$
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName}\\
      & $\ctxl_1, x: \tau_1 \byinf \applye {\ctxl_1} {e_1} \infto
      \applye {\ctxl_1} {\sigma'}$
      & By definition of context application \\
      & $\ctxl_1, x: \tau_1 \exto \ctxl, x:\tau_1$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl_1 \exto \ctxl$
      & By inversion \\
      & $\applye {\ctxl, x: \tau_1} {\applye {\ctxl_1} {e_1}}
      = \applye {\ctxl, x: \tau_1} {e_2}$
      & By induction hypothesis \\
      & $\applye {\ctxl} {\applye {\ctxl_1} {e_1}}
      = \applye {\ctxl} {e_2}$
      & By definition of context application \\
      & $\applye {\ctxl} {e_1}
      = \applye {\ctxl} {e_2}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\applye {\ctxl} {\tau_1} = \applye {\ctxl} {\tau_2}$
      & Similarly
    \end{longtable}
  \item Case \[\IPi\]
    Similar as Case \rul{I-LamAnn}.
  \item Case \[\ICastDn\]
    Follows directly from induction hypothesis.
  \item Case \[\ICastUp\]
    Follows directly from induction hypothesis.
\end{itemize}

\qed

\begin{lemma}[\TypeSanitizationWellFormednessName]
  \label{lemma:\TypeSanitizationWellFormednessName}
  \TypeSanitizationWellFormednessBody
\end{lemma}

\proof

By induction on the type sanitization.

\begin{itemize}
  \item Case \[\IEVarAfter\]
    \begin{longtable}[l]{lll}
    & $\tau_1 = \genB$, $\sigma = \star$ & By inversion  \\
    & $\tctx[\genA_1, \genA][\genB =\genA_1] \byinf \genA_1 \infto \star$
    & Follows directly by \rul{A-EVar}.
    \end{longtable}
  \item Case \[\IEVarBefore\]
    Holds trivially.
  \item Case \[\IStar\]
    Holds trivially.
  \item Case \[\IApp\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf e_1 \infto \bpi x {\sigma_1} {\sigma_2}$ & By inversion \\
      & $\tctx \byinf e_2 \infto \sigma_1$ & By inversion \\
      & $\sigma = \sigma_2 \subst x {\applye \tctx {e_2}}$ & By inversion \\
      & $\ctxl_1 \byinf e_3 \infto \applye {\ctxl_1} {\bpi x {\sigma_1} {\sigma_2}}$
      & By induction hypothesis \\
      & $\tctx \exto \ctxl_1$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl_1 \byinf e_2 \infto \applye {\ctxl_1} {\sigma_1}$
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_2} \infto
      {\applye {\ctxl_1} {\sigma_1}}$
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl \byinf e_4 \infto \applye {\ctxl} {\applye {\ctxl_1} {\sigma_1}}$
      & By induction hypothesis \\
      & $\ctxl_1 \exto \ctxl$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl \byinf e_4 \infto \applye {\ctxl} {\sigma_1}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\ctxl \byinf e_3 \infto \applye \ctxl {\applye {\ctxl_1} {\bpi x {\sigma_1} {\sigma_2}}}$
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl \byinf e_3 \infto \applye \ctxl {\bpi x {\sigma_1} {\sigma_2}}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\ctxl \byinf e_3 ~ e_4 \infto (\applye \ctxl {\sigma_2}) \subst x
      {\applye \ctxl {e_4}} $
      & By \rul{A-App} \\
      & $\applye \ctxl {\applye {\ctxl_1} {e_2}} = \applye \ctxl {e_4} $
      & By Lemma~\ref{lemma:\TypeSanitizationEquivalenceName} \\
      & $\applye \ctxl {e_2} = \applye \ctxl {e_4} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\ctxl \byinf e_3 ~ e_4 \infto (\applye \ctxl {\sigma_2}) \subst x
      {\applye \ctxl {e_2}} $
      & By substituting above equality \\
      & $\tctx \exto \ctxl$
      & By Lemma~\ref{lemma:\ContextExtensionTransitivityName} \\
      & $\applye \ctxl {e_2} = \applye \ctxl {\applye {\tctx} {e_2}}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\ctxl \byinf e_3 ~ e_4 \infto (\applye \ctxl {\sigma_2}) \subst x
      {\applye \ctxl {\applye \tctx {e_2}}} $
      & By substituting above equality \\
      & $\ctxl \byinf e_3 ~ e_4 \infto \applye \ctxl
      {\sigma_2 \subst x {\applye \tctx {e_2}}} $
      & By property of substitution
    \end{longtable}
  \item Case \[\ILamAnn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \tau_1 \infto \star $ & By inversion \\
      & $\tctx, x: \tau_1 \byinf e_1 \infto \sigma_1$ & By inversion \\
      & $\sigma = \bpi x {\applye \tctx {\tau_1}} {\sigma_1}$ & By inversion \\
      & $\ctxl_1 \byinf \tau_2 \infto \star$
      & By induction hypothesis \\
      & $\tctx \exto \ctxl_1$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\tctx, x: \tau_1 \exto \ctxl_1, x:\tau_1$
      & By \rul{CE-Var} \\
      & $\ctxl_1, x: \tau_1 \byinf e_1 \infto \applye {\ctxl_1, x: \tau_1} {\sigma_1}$
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1, x: \tau_1 \byinf \applye {\ctxl_1, x: \tau_1} {e_1}
      \infto \applye {\ctxl_1, x : \tau_1} {\sigma_1}$
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1, x: \tau_1 \byinf \applye {\ctxl_1} {e_1}
      \infto \applye {\ctxl_1} {\sigma_1}$
      & By definition on context application \\
      & $\ctxl, x:\tau_1 \byinf e_2 \infto \applye {\ctxl, x :\tau_1} {\applye {\ctxl_1} {\sigma_1}}$
      & By induction hypothesis \\
      & $\ctxl, x:\tau_1 \byinf e_2 \infto \applye {\ctxl} {\applye {\ctxl_1} {\sigma_1}}$
      & By definition of context substitution \\
      & $\ctxl_1, x:\tau_1 \exto \ctxl, x : \tau_1$
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl_1 \exto \ctxl$
      & By inversion \\
      & $\ctxl, x: \tau_1 \byinf e_2 \infto \applye {\ctxl} {\sigma_1}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\ctxl \byinf \tau_2 \infto \star$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\tctx \exto \ctxl$
      & By Lemma~\ref{lemma:\ContextExtensionTransitivityName} \\
      & $\ctxl \byinf \tau_1 \infto \star$
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl \byinf \applye {\ctxl} {\tau_1} \infto \star$
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl, x: \applye \ctxl {\tau_1} \byinf e_2 \infto \applye {\ctxl} {\sigma_1}$
      & By Lemma~\ref{lemma:\ContextApplicationInContextName} \\
      & $\applye {\ctxl_1} {\tau_1} = \applye {\ctxl_1} {\tau_2} $
      & By Lemma~\ref{lemma:\TypeSanitizationEquivalenceName} \\
      & $\applye {\ctxl} {\tau_1} = \applye {\ctxl} {\tau_2} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\ctxl, x: \applye \ctxl {\tau_2} \byinf e_2 \infto \applye {\ctxl} {\sigma_1}$
      & By substituting above equality \\
      & $\ctxl, x: {\tau_2} \byinf e_2 \infto \applye {\ctxl} {\sigma_1}$
      & By Lemma~\ref{lemma:\ReverseContextApplicationInContextName}\\
      & $\ctxl \byinf \blam x {\tau_2} {e_2} \infto \bpi x {\applye \ctxl
        {\tau_2}} {\applye \ctxl {\sigma_1}} $
      & By \rul{A-LamAnn} \\
      & $\bpi x {\applye \ctxl {\tau_2}} {\applye \ctxl {\sigma_1}}$ & \\
      & $= \bpi x {\applye \ctxl {\applye {\tctx} {\tau_2}}} {\applye \ctxl
        {\sigma_1}}$
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $= \applye \ctxl {\bpi x {\applye {\tctx} {\tau_2}} {\sigma_1}}$
      & By property of substitution
    \end{longtable}
  \item Case \[\IPi\]
    Similar as Case \rul{I-LamAnn}.
  \item Case \[\ICastDn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf e_1 \infto \sigma_1 $ & By inversion \\
      & $\sigma_1 \redto \sigma$ & By inversion \\
      & $\ctxl \byinf e_2 \infto \applye \ctxl {\sigma_1} $
      & By induction hypothesis \\
      & $\applye \ctxl {\sigma_1} \redto \applye \ctxl {\sigma}$
      & By Lemma~\ref{lemma:\ContextApplicationOverReductionName} \\
      & $\ctxl \byinf \castdn e_2 \infto \applye \ctxl \sigma$
      & By \rul{A-CastDn}
    \end{longtable}
  \item Case \[\ICastUp\]
    Similar as Case \rul{I-CastDn}
\end{itemize}

\qed

\begin{lemma}[\TypeSanitizationTailUnchangedName]
  \label{lemma:\TypeSanitizationTailUnchangedName}
  \TypeSanitizationTailUnchangedBody
\end{lemma}

\proof

By a straightforward induction on the type sanitization derivation.

\qed

We use the notation $\tctx \bywf \tau_1 = \tau_2$ to mean that
$\tctx \byinf \tau_1 \infto \sigma$, $\tctx \byinf \tau_2 \infto \sigma$,
and $\tau_1 = \tau_2$.

\begin{lemma}[\TypeSanitizationCompletenessName]\leavevmode
  \label{lemma:\TypeSanitizationCompletenessName}
  \TypeSanitizationCompletenessBody
\end{lemma}

By induction on the type $\tau$.

We then case analyze the shape of $\sigma_1$.

\begin{itemize}
  \item $\sigma_1 = \genB$
      \begin{longtable}[l]{lll}
        & $\genA \notin FV(\sigma_1)$
        & Given \\
        & $\genA \neq \genB$
        & Follows directly \\
        & $\applye \cctx \genB = \tau$
        & Given \\
        & $\cctx \byinf \genB \infto \star$
        & By \rul{A-SolvedEVar} \\
        & $\cctx \byinf \tau \infto \star$
        & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
        & $\applye \tctx \genB = \genB$
        & Given \\
        & $\genB \in unsolved(\tctx)$
        & Follows directly \\
      \end{longtable}
      According to whether $\genB$ is on the left of $\genA$ or right, we have
      two cases.
      \begin{itemize}
      \item SubCase $\tctx = \tctx_1, \genA, \tctx_3, \genB, \tctx_4 $.
        \begin{longtable}[l]{lll}
          & $\tctx_1, \genA, \tctx_3, \genB, \tctx_4 \bysa \genB \sa \genA_1
          \toctxo_1, \genA_1, \genA, \tctx_3, \genB = \genA_1, \tctx_4
          $
          & By \rul{I-EVarAfter} \\
          & $\tctx_1, \genA, \tctx_3, \genB, \tctx_4 \exto \cctx $
          & Given \\
          & $\cctx = \cctx_1, \genA = \tau', \cctx_2$
          & By Lemma~\ref{lemma:\ExtensionOrderName} \\
          & $\tctx_1 \exto \cctx_1$
          & As above \\
          & $\tctx_1 \bywt \tau$
          & Given \\
          & $\cctx_1 \bywt \tau$
          & By Lemma~\ref{lemma:\ExtensionWeakeningWellScopednessName} \\
          & $\cctx_1, \genA = \tau', \cctx_2 \byinf \tau \infto \star$
          & Known \\
          & $\cctx_1 \byinf \tau \infto \star$
          & By Lemma~\ref{lemma:\TypingStrengtheningName} \\
          & $\tctx_1 \bywt \tau$
          & Known \\
          & $\tctx_1 \byinf \tau \infto \star$
          & By repeating Lemma~\ref{lemma:\TypingStrengtheningName} \\
          & $\tctx_1, \genA_1 = \tau, \genA, \tctx_3, \genB, \tctx_4 \exto
          \cctx_1, \genA_1 = \tau, \genA = \tau', \cctx_2 $
          & By Lemma~\ref{lemma:\ParallelAdmissibilityName} \\
          & $\applye {\cctx_1, \genA_1 = \tau, \genA = \tau', \cctx_2} \genB = \tau $
          & Known \\
          & $\tctx_1, \genA_1 = \tau, \genA, \tctx_3, \genB = \genA_1, \tctx_4 \exto
          \cctx_1, \genA_1 = \tau, \genA = \tau', \cctx_2 $
          & By Lemma~\ref{lemma:\ParallelExtensionSolutionName} \\
          & $\tctx_1, \genA_1, \genA , \tctx_3, \genB = \genA_1,
          \tctx_4
          \exto
          \tctx_1, \genA_1 = \tau, \genA, \tctx_3, \genB =
          \genA_1, \tctx_4 $
          &  By Lemma~\ref{lemma:\SolutionAdmissibilityForExtensionName} \\
          & $\tctx_1, \genA_1, \genA, \tctx_3, \genB = \genA_1,
          \tctx_4
          \exto
          \cctx_1, \genA_1 = \tau, \genA = \tau', \cctx_2
          $
          & By Lemma~\ref{lemma:\ContextExtensionTransitivityName} \\
          & $\cctx' =
          \cctx_1, \genA_1 = \tau, \genA = \tau', \cctx_2
          $
          & Choose \\
          & $\cctx_1, \genA = \tau', \cctx_2 \exto \cctx_1, \genA_1 = \tau,
          \genA = \tau', \cctx_2$
          & By Lemma~\ref{lemma:\SolvedVariableAdditionForExtensionName} \\
        \end{longtable}
      \item SubCase $\tctx = \tctx_1, \genB, \tctx_3, \genA, \tctx_4 $.
        \begin{longtable}[l]{lll}
          & $\tctx_1, \genB, \tctx_3, \genA, \tctx_4 \bysa \genB \sa \genB
          \toctxo_1, \genB, \tctx_3, \genA, \tctx_4
          $
          & By \rul{I-EVarBefore} \\
          & $\tctx_1, \genB, \tctx_3, \genA, \tctx_4 \exto \cctx $
          & Given \\
          & $\cctx' = \cctx$
          & Choose \\
          & $\cctx \exto \cctx'$
          & By Lemma~\ref{lemma:\ContextExtensionReflexivityName} \\
        \end{longtable}
      \end{itemize}
    \item Case $\sigma_1 = x$.
      \begin{longtable}[l]{lll}
        & $\applye \cctx x = x$
        & By definition of context application \\
        & $\tau = x$
        & Given \\
        & $\tctx_1 \bywt x$
        & Given \\
        & $\tctx_1, \genA, \tctx_2 \bysa x \sa x \toctxo_1, \genA, \tctx_2 $
        & By \rul{I-Var} \\
        & $\cctx' = \cctx$
        & Choose \\
        & $\cctx \exto \cctx'$
        & By Lemma~\ref{lemma:\ContextExtensionReflexivityName} \\
      \end{longtable}
    \item Case $\sigma_1 = \star$.
      \begin{longtable}[l]{lll}
        & $\applye \cctx \star = \star$
        & By definition of context application \\
        & $\tau = \star$
        & Given \\
        & $\tctx_1 \bywt \star$
        & Given \\
        & $\tctx_1, \genA, \tctx_2 \bysa \star \sa \star \toctxo_1, \genA, \tctx_2 $
        & By \rul{I-Star} \\
        & $\cctx' = \cctx$
        & Choose \\
        & $\cctx \exto \cctx'$
        & By Lemma~\ref{lemma:\ContextExtensionReflexivityName} \\
      \end{longtable}
    \item Case $\sigma_1 = e_1 ~ e_2$.
      \begin{longtable}[l]{lll}
        & $\applye \cctx {e_1 ~ e_2} = {\applye \cctx {e_1}} ~ {\applye \cctx {e_2}}$
        & By definition of context application \\
        & $\tau = \tau_1 ~ \tau_2$
        & By inversion \\
        & $ \applye {\cctx} \tctx \bywf \tau_1 = {\applye \cctx {e_1}}$
        & As above \\
        & $ \applye {\cctx} \tctx \bywf \tau_2 = {\applye \cctx {e_2}}$
        & As above \\
        & $\tctx \bysa e_1 \sa e_3 \toctx $
        & By induction hypothesis \\
        & $\ctxl = \ctxl_1, \genA, \ctxl_2 $
        & As above \\
        & $\ctxl_1 \bywt e_3$
        & As above \\
        & $\ctxl \exto \cctx_1$
        & As above \\
        & $\cctx \exto \cctx_1$
        & As above \\
        & $\tctx \exto \ctxl$
        & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
        & $\tctx \exto \cctx_1$
        & By Lemma~\ref{lemma:\ContextExtensionTransitivityName} \\
        & $\applye {\cctx} \cctx \bywf \tau_2 = {\applye \cctx {e_2}}$
        & By Lemma~\ref{lemma:\StabilityOfCompleteContextsName} \\
        & $\applye {\cctx_1} {\cctx_1} \bywf \tau_2 = {\applye \cctx {e_2}}$
        & By Lemma~\ref{lemma:\FinishingCompletionsName} \\
        & $\applye {\cctx_1} {\cctx_1} \bywf \tau_2 = {\applye {\cctx_1} {e_2}}$
        & By Lemma~\ref{lemma:\FinishingTypesName} \\
        & $\applye {\cctx_1} {\ctxl} \bywf \tau_2 = {\applye {\cctx_1} {e_2}}$
        & By Lemma~\ref{lemma:\StabilityOfCompleteContextsName} \\
        & $\applye {\cctx_1} {\ctxl} \bywf \tau_2 =
        {\applye {\cctx_1} {\applye \ctxl {e_2}}}$
        & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
        & $\ctxl \bysa \applye \ctxl {e_2} \sa e_4 \toctxr $
        & By induction hypothesis \\
        & $\ctxr = \ctxr_1, \genA, \ctxr_2$
        & As above \\
        & $\ctxr \exto \cctx_2$
        & As above \\
        & $\cctx_1 \exto \cctx_2$
        & As above \\
        & $\ctxr_1 \bywt e_4$
        & As above \\
        & $\ctxl_1 \exto \ctxr_1$
        & By Lemma~\ref{lemma:\ExtensionOrderName} \\
        & $\ctxr_1 \bywt e_3$
        & By Lemma~\ref{lemma:\ExtensionWeakeningWellScopednessName} \\
        & $\ctxr_1 \bywt e_3 ~ e_4$
        & Follows directly \\
        & $\tctx \bysa e_1~e_2 \sa e_3~e_4 \toctxr$
        & By \rul{I-App} \\
        & $\cctx' = \cctx_2$
        & Choose \\
        & $\cctx \exto \cctx_2$
        & By Lemma~\ref{lemma:\ContextExtensionTransitivityName}
      \end{longtable}
    \item Case $\sigma_1 = \blam x \sigma e$.
      \begin{longtable}[l]{lll}
        & $\applye \cctx {\blam x \sigma e} = \blam x {\applye \cctx {\sigma}} {\applye \cctx {e}}$
        & By definition of context application \\
        & $\tau = \blam x {\tau_1} {\tau_2}$
        & By inversion \\
        & $ \applye {\cctx} \tctx \bywf \tau_1 = {\applye \cctx {\sigma}}$
        & As above \\
        & $ \applye {\cctx} \tctx, x: \tau_1 \bywf \tau_2 = {\applye \cctx {e}}$
        & As above \\
        & $\tctx \bysa \sigma \sa \sigma' \toctx $
        & By induction hypothesis \\
        & $\ctxl = \ctxl_1, \genA, \ctxl_2 $
        & As above \\
        & $\ctxl_1 \bywt e_3$
        & As above \\
        & $\ctxl \exto \cctx_1$
        & As above \\
        & $\cctx \exto \cctx_1$
        & As above \\
        & $\tctx \exto \ctxl$
        & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
        & $\tctx \exto \cctx_1$
        & By Lemma~\ref{lemma:\ContextExtensionTransitivityName} \\
        % & $ \applye {\cctx, x: \tau_1} {\tctx, x: \tau_1} \bywf
        % \tau_2 = {\applye {\cctx, x: \tau_1} {e}}$
        % & By definition of context application \\
        & $\applye \cctx \tctx \bywf \tau_1$
        & Known \\
        & $\applye \cctx \tctx \exto \cctx $
        & By Lemma~\ref{lemma:\CompleteContextApplicationExtensionName} \\
        & $\cctx \bywf \tau_1$
        & By Corollary~\ref{lemma:\ExtensionWeakningWellFormednessName} \\
        & $\cctx = \cctx_{01}, \genA = \tau', \cctx_{02} $
        & By Lemma~\ref{lemma:\ExtensionOrderName} \\
        & $\tctx_1 \exto \cctx_{01}$
        & As above \\
        & $\tctx_1 \bywt \tau_1 $
        & Known \\
        & $\cctx_1 = \cctx_{11}, \genA = \tau', \cctx_{12} $
        & By Lemma~\ref{lemma:\ExtensionOrderName} \\
        & $\tctx_1 \exto \cctx_{11}$
        & As above \\
        & $\cctx_{11} \bywt \tau_1 $
        & By Lemma~\ref{lemma:\ExtensionWeakeningWellScopednessName} \\
        & $\cctx_{11} \bywf \tau_1 $
        & By Lemma~\ref{lemma:\TypingStrengtheningName} \\
        & $\tau_1$ contains no existential variables
        & Known \\
        & $\tctx_{11} \bywf \tau_1 $
        & By repeating Lemma~\ref{lemma:\TypingStrengtheningName} \\
        & $\tctx_1, x: \tau_1, \genA = \tau', \tctx_2 \exto
        \cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02} $
        & By Lemma~\ref{lemma:\ParallelAdmissibilityName} \\
        & $\tctx_1, x: \tau_1, \genA = \tau', \tctx_2 \exto
        \cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12} $
        & Similarly \\
        & $\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02} \exto
        \cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12} $
        & Similarly \\
        & $\ctxl_1, x: \tau_1, \genA = \tau', \ctxl_{2} \exto
        \cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12} $
        & Similarly \\
        & $ \applye {\cctx} \tctx, x: \tau_1 \bywf \tau_2 = {\applye \cctx {e}}$
        & Known \\
        & $ \applye {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}} {\tctx_1, x:
          \tau_1, \genA, \tctx_2} \bywf
        \tau_2 = {\applye {\cctx} {e}}$
        & By repeating Lemma~\ref{lemma:\TypingVariableExchangeName} \\
        & $ \applye {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}} {\tctx_1, x:
          \tau_1, \genA, \tctx_2} $\\
        & $\bywf
        \tau_2 = {\applye {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}}
          {e}}$
        & By definition of context application \\
        & $\applye {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}}
        {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}}$\\
        & $ \bywf
        \tau_2 = {\applye {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}} {e}}$
        & By Lemma~\ref{lemma:\StabilityOfCompleteContextsName} \\
        & $\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}
        {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}$\\
        & $ \bywf
        \tau_2 = {\applye {\cctx_{01}, x: \tau_1, \genA = \tau', \cctx_{02}} {e}}$
        & By Lemma~\ref{lemma:\FinishingCompletionsName} \\
        & $\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}
        {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}$\\
        & $ \bywf \tau_2
        = {\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}} {e}}$
        & By Lemma~\ref{lemma:\FinishingTypesName} \\
        & $\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}
        {\ctxl_1, x: \tau_1, \genA = \tau', \ctxl_{2}}$\\
        & $ \bywf \tau_2
        = {\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}} {e}}$
        & By Lemma~\ref{lemma:\StabilityOfCompleteContextsName} \\
        & $\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}
        {\ctxl_1, x: \tau_1, \genA = \tau', \ctxl_{2}}$\\
        & $ \bywf \tau_2
        = {\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}} {
            \applye {{\ctxl_1, x: \tau_1, \genA = \tau', \ctxl_{2}}} e}}$
        & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
        & $\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}}
        {\ctxl_1, x: \tau_1, \genA = \tau', \ctxl_{2}}$\\
        & $ \bywf \tau_2
        = {\applye {\cctx_{11}, x: \tau_1, \genA = \tau', \cctx_{12}} {
            \applye {\ctxl} e}}$
        & By definition of context application \\
        & $\ctxl_1, x: \tau_1,\genA = \tau', \ctxl_2 \bysa \applye \ctxl {e} \sa e' \toctxr $
        & By induction hypothesis \\
        & $\ctxr = \ctxr_1, x: \tau_1, \ctxr_2, \genA, \ctxr_3 $
        & As above and Lemma~\ref{lemma:\TypeSanitizationExtensionName} and
        Lemma~\ref{lemma:\ExtensionOrderName}\\
        & $\ctxr \exto \cctx_2$
        & As above \\
        & $\cctx_1, x: \tau_1 \exto \cctx_2$
        & As above \\
        & $\ctxr_1 \bywt e'$
        & As above \\
        & $\ctxl_1 \exto \ctxr_1$
        & By Lemma~\ref{lemma:\ExtensionOrderName} \\
        & $\ctxr_1 \bywt \sigma'$
        & By Lemma~\ref{lemma:\ExtensionWeakeningWellScopednessName} \\
        & $\ctxr_1 \bywt e_3 ~ e_4$
        & Follows directly \\
        & $\tctx \bysa e_1~e_2 \sa e_3~e_4 \toctxr$
        & By \rul{I-App} \\
        & $\cctx' = \cctx_2$
        & Choose \\
        & $\cctx \exto \cctx_2$
        & By Lemma~\ref{lemma:\ContextExtensionTransitivityName}
      \end{longtable}
\end{itemize}

\subsection{Properties of Unification}

\begin{lemma}[\UnificationExtensionName]\leavevmode
  \label{lemma:\UnificationExtensionName}
  \UnificationExtensionBody
\end{lemma}

\proof

By induction on the height of unification derivation.
Two parts reply on each
other but the size of derivation is decreasing.
So the proof can terminate.

\begin{description}
\item [Part 1] In Part 1, we regard all $\delta = e$.
  \begin{itemize}
  \item Case \[\UAEq\]
    Follows trivially by Lemma~\ref{lemma:\ContextExtensionReflexivityName}.
  \item Case \[\UApp\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf e_1 ~ e_2 \infto \sigma_1' $ & Given \\
      & $\tctx \byinf e_3 ~ e_4 \infto \sigma_2' $ & Given \\
      & $\tctx \byinf e_1 \infto \sigma_1'' $ & By inversion \\
      & $\tctx \byinf e_3 \infto \sigma_2'' $ & By inversion \\
      & $\tctx \exto \ctxl_1 $ & By induction hypothesis \\
      & $\tctx \byinf e_2 \infto \sigma_1''' $ & By inversion \\
      & $\tctx \byinf e_4 \infto \sigma_2''' $ & By inversion \\
      & $\ctxl_1 \byinf e_2 \infto \applye {\ctxl_1} {\sigma_1'''} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf e_4 \infto \applye {\ctxl_1} {\sigma_2'''} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_2} \infto
      \applye {\ctxl_1} {\sigma_1'''} $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_4} \infto
      {\applye {\ctxl_1} {\sigma_2'''}} $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1 \exto \ctxl$
      & By induction hypothesis \\
      & $\tctx \exto \ctxl$
      & By Lemma~\ref{lemma:\ContextExtensionTransitivityName}
    \end{longtable}
  \item Case \[\ULamAnn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \blam x {\sigma_1} {e_1} \infto \sigma_1' $ & Given \\
      & $\tctx \byinf \sigma_1 \infto \star $ & By inversion \\
      & $\tctx \byinf \blam x {\sigma_2} {e_2} \infto \sigma_2' $ & Given \\
      & $\tctx \byinf \sigma_2 \infto \star $ & By inversion \\
      & $\tctx \exto \ctxl_1 $ & By Part 2 \\
      & $\tctx, x:\sigma_1 \exto \ctxl_1, x:\sigma_1 $
      & By \rul{CE-Var} \\
      & $\tctx, x:\sigma_1 \byinf e_1 \infto \sigma_1'' $ & By inversion \\
      & $\ctxl_1, x: \sigma_1 \byinf e_1 \infto \applye {\ctxl_1, x:\sigma_1} {\sigma_1''} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1, x: \sigma_1 \byinf \applye {\ctxl_1, x: \sigma_1} {e_1} \infto
       {\applye {\ctxl_1, x:\sigma_1} {\sigma_1''}} $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1, x: \sigma_1 \byinf \applye {\ctxl_1} {e_1} \infto
      {\applye {\ctxl_1} {\sigma_1''}} $
      & By definition of context substitution \\
      & $\ctxl_1, x: \sigma_1 \byinf \applye {\ctxl_1} {e_2} \infto
      {\applye {\ctxl_1} {\sigma_2''}} $
      & Similarly \\
      & $\ctxl_1, x:\sigma_1 \exto \ctxl, x:\sigma_1 $
      & By induction hypothesis \\
      & $\ctxl_1 \exto \ctxl $
      & By inversion \\
      & $\tctx \exto \ctxl$
      & By Lemma~\ref{lemma:\ContextExtensionTransitivityName}
    \end{longtable}
  \item Case \[\UPi\]
    Similar as Case \rul{U-LamAnn}.
    The difference is that instead of using induction hypothesis,
    two subgoals all use Part 2.
  \item Case \[\UCastDn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \castdn {e_1} \infto \sigma_1'$ & Given \\
      & $\tctx \byinf e_1 \infto \sigma_1''$ & By inversion \\
      & $\tctx \byinf e_2 \infto \sigma_2''$ & Similarly \\
      & $\tctx \exto \ctxl$ & By induction hypothesis
    \end{longtable}
  \item Case \[\UCastUp\]
    Similar as Case \rul{U-CastDn}.
  \end{itemize}
\item [Part 2]
  \begin{itemize}
  \item Case \[\UAEq\]
    Follows trivially by Lemma~\ref{lemma:\ContextExtensionReflexivityName}.
  \item Case \[\UEVarTy\]
    \begin{longtable}[l]{lll}
      & $\tctx[\genA] \byinf \tau_1 \infto \star $& Given \\
      & $\tctx[\genA] \exto \ctxl_1, \genA, \ctxl_2 $
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl_1, \genA, \ctxl_2 \byinf \tau_2 \infto \star $
      & By Lemma~\ref{lemma:\TypeSanitizationWellFormednessName} \\
      & $\ctxl_1 \bywt \tau_2$
      & Given \\
      & $\ctxl_1 \byinf \tau_2 \infto \star $
      & By Lemma~\ref{lemma:\TypingStrengtheningName} \\
      & $\ctxl_1, \genA, \ctxl_2 \exto \ctxl_1, \genA = \tau_2, \ctxl_2$
      & By Lemma~\ref{lemma:\SolvedVariableAdditionForExtensionName} \\
      & $\tctx[\genA] \exto \ctxl_1, \genA = \tau_2, \ctxl_2$
      & By Lemma~\ref{lemma:\ContextExtensionTransitivityName} \\
    \end{longtable}
  \item Case \[\UTyEVar\]
    Similar as Case \rul{U-EVarTy}.
  \item Case \[\UApp\]
    Similar as Case \rul{U-App} in Part 1.
  \item Case \[\UPi\]
    Similar as Case \rul{U-Pi} in Part 1.
  \item Case \[\UCastDn\]
    Similar as Case \rul{U-CastDn} in Part 1.
  \end{itemize}
\end{description}

\qed

\begin{lemma}[\UnificationEquivalenceName]\leavevmode
  \label{lemma:\UnificationEquivalenceName}
  \UnificationEquivalenceBody
\end{lemma}

\proof

By induction on unification derivation.

\begin{itemize}
  \item Case \[\UAEq\]
    The goal holds trivially.
  \item Case \[\UEVarTy\]
    \begin{longtable}[l]{lll}
      & $\tctx[\genA] \byinf \tau_1 \infto \sigma_2' $ & Given \\
      & $\applye {\ctxl_1, \genA, \ctxl_2} {\tau_1}
      = \applye {\ctxl_1, \genA, \ctxl_2} {\tau_2} $
      & By Lemma~\ref{lemma:\TypeSanitizationEquivalenceName} \\
      & $\applye {\ctxl_1, \genA = \tau_2, \ctxl_2} \genA $ & \\
      & $ = \applye {\ctxl_1} {\tau_2} $
      & By definition of context substitution \\
      & $\applye {\ctxl_1, \genA = \tau_2, \ctxl_2} {\tau_1}$ & \\
      & $= \applye {\ctxl_1, \genA = \tau_2} {\applye {\ctxl_2} {\tau_1}} $
      & By definition of context application \\
      & $= \applye {\ctxl_1} {(\applye {\ctxl_2} {\tau_1}) \subst \genA
        {\tau_2}} $
      & By definition of context application \\
      & $= (\applye {\ctxl_1} {\applye {\ctxl_2} {\tau_1}}) \subst \genA
        {\applye {\ctxl_1} {\tau_2}} $
      & By property of context application and substitution \\
      & $= (\applye {\ctxl_1, \ctxl_2} {\tau_1}) \subst \genA
        {\applye {\ctxl_1} {\tau_2}} $
      & By definition of context application \\
      & $= (\applye {\ctxl_1, \genA, \ctxl_2} {\tau_1}) \subst \genA
        {\applye {\ctxl_1} {\tau_2}} $
      & By definition of context application \\
      & $= (\applye {\ctxl_1, \genA, \ctxl_2} {\tau_2}) \subst \genA
        {\applye {\ctxl_1} {\tau_2}} $
      & By substituting the equality \\
      & $\ctxl_1 \bywt \tau_2 $ & Given \\
      & $\tctx[\genA] \wc$
      & By Lemma~\ref{lemma:\TypingContextWellFormednessName} \\
      & $\tctx[\genA] \exto \ctxl_1, \genA, \ctxl_2 $
      & By Lemma~\ref{lemma:\TypeSanitizationExtensionName} \\
      & $\ctxl_1, \genA, \ctxl_2 \wc $
      & By Lemma~\ref{lemma:\ContextExtensionPreservesContextWellFormednessName}\\
      & $\genA \notin \ctxl_1 \cup FV(\tau_2)$
      & Follows directly \\
      & $\tau_2$ contains no existential variable in $\ctxl_2$
      & Follows directly \\
      & $\applye {\ctxl_1, \genA = \tau_2, \ctxl_2} {\tau_1}$ & \\
      & $= (\applye {\ctxl_1, \genA, \ctxl_2} {\tau_2}) \subst \genA
      {\applye {\ctxl_1} {\tau_2}} $
      & Known \\
      & $= (\applye {\ctxl_1} {\tau_2}) \subst \genA {\applye {\ctxl_1} {\tau_2}}$
      & Substitute fresh context \\
      & $= (\applye {\ctxl_1} {\tau_2})$
      & Substitute fresh variable \\
    \end{longtable}
  \item Case \[\UTyEVar\]
    Similar as Case \rul{U-EVarTy}.
  \item Case \[\UApp\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf e_1 ~ e_2 \infto \sigma_1'$ & Given \\
      & $\tctx \byinf e_1 \infto \sigma_1''$ & By inversion \\
      & $\tctx \byinf e_2 \infto \sigma_1'''$ & By inversion \\
      & $\tctx \byinf e_3 ~ e_4 \infto \sigma_2'$ & Given \\
      & $\tctx \byinf e_3 \infto \sigma_2''$ & By inversion \\
      & $\tctx \byinf e_4 \infto \sigma_2'''$ & By inversion \\
      & $\applye {\ctxl_1} {e_1} = \applye {\ctxl_1} {e_3}$
      & By induction hypothesis \\
      & $\tctx \exto \ctxl_1$
      & By Lemma~\ref{lemma:\UnificationExtensionName} \\
      & $\ctxl_1 \byinf e_2 \infto \applye {\ctxl_1} {\sigma_1'''}$
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_2} \infto
      {\applye {\ctxl_1} {\sigma_1'''}}$
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {e_4} \infto \applye {\ctxl_1}
      {\sigma_2'''}$
      & Similarly \\
      & $\applye \ctxl {\applye {\ctxl_1} {e_2}}
      = \applye \ctxl {\applye {\ctxl_1} {e_4}} $
      & By induction hypothesis \\
      & $\ctxl_1 \exto \ctxl $
      & By Lemma~\ref{lemma:\UnificationExtensionName} \\
      & $\applye \ctxl {e_2} = \applye \ctxl {e_4} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\applye \ctxl {e_1} = \applye \ctxl {e_3} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
    \end{longtable}
  \item Case \[\ULamAnn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \blam x {\sigma_1} {e_1} \infto \sigma_1' $
      & Given \\
      & $\tctx \byinf {\sigma_1} \infto \star $
      & By inversion \\
      & $\tctx, x: \sigma_1 \byinf {e_1} \infto \sigma_1'' $
      & By inversion \\
      & $\tctx \byinf {\sigma_2} \infto \star $
      & Similarly \\
      & $\tctx, x: \sigma_2 \byinf {e_2} \infto \sigma_2'' $
      & Similarly \\
      & $\applye {\ctxl_1} {\sigma_1} = \applye {\ctxl_1} {\sigma_2} $
      & By induction hypothesis \\
      & $\tctx \exto \ctxl_1 $
      & By Lemma~\ref{lemma:\UnificationExtensionName} \\
      & $\tctx, x: \sigma_1 \exto \ctxl_1, x:\sigma_1 $
      & By \rul{CE-Var} \\
      & $\ctxl_1, x: \sigma_1 \byinf {e_1} \infto \applye {\ctxl_1, x: \sigma_1}
      {\sigma_1''} $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1, x: \sigma_1 \byinf {\applye {\ctxl_1, x: \sigma_1} {e_1}}
      \infto \applye {\ctxl_1, x: \sigma_1} {\sigma_1''}$
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1, x: \sigma_1 \byinf {\applye {\ctxl_1} {e_1}}
      \infto \applye {\ctxl_1} {\sigma_1''}$
      & By definition of context substitution\\
      & $\tctx, x: \sigma_2 \exto \ctxl_1, x:\sigma_2 $
      & By \rul{CE-Var} \\
      & $\ctxl_1, x: \sigma_2 \byinf \applye {\ctxl_1} {e_2} \infto \applye
      {\ctxl_1} {\sigma_2''} $
      & Similarly \\
      & $\ctxl_1 \byinf {\sigma_2} \infto \star $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1 \byinf \applye {\ctxl_1} {\sigma_2} \infto \star $
      & By Lemma~\ref{lemma:\ContextApplicationPreservesTypingName} \\
      & $\ctxl_1, x: \applye {\ctxl_1} {\sigma_2} \byinf \applye {\ctxl_1} {e_2} \infto \applye
      {\ctxl_1} {\sigma_2''} $
      & By Lemma~\ref{lemma:\ContextApplicationInContextName} \\
      & $\ctxl_1, x: \applye {\ctxl_1} {\sigma_1} \byinf \applye {\ctxl_1} {e_2} \infto \applye
      {\ctxl_1} {\sigma_2''} $
      & By substituting the equality \\
      & $\ctxl_1 \byinf {\sigma_1} \infto \star $
      & By Lemma~\ref{lemma:\ExtensionWeakningName} \\
      & $\ctxl_1, x: \sigma_1 \byinf \applye {\ctxl_1} {e_2} \infto \applye
      {\ctxl_1} {\sigma_2''} $
      & By Lemma~\ref{lemma:\ReverseContextApplicationInContextName} \\
      & $\applye {\ctxl, x:\sigma_1} {\applye {\ctxl_1} {e_1}}
      = \applye {\ctxl, x: \sigma_1} {\applye {\ctxl_1} {e_2}} $
      & By induction hypothesis \\
      & $\applye {\ctxl} {\applye {\ctxl_1} {e_1}}
      = \applye {\ctxl} {\applye {\ctxl_1} {e_2}} $
      & By definition of context application \\
      & $\ctxl_1, x: \sigma_1 \exto \ctxl, x: \sigma_1 $
      & By Lemma~\ref{lemma:\UnificationExtensionName} \\
      & $\ctxl_1 \exto \ctxl $
      & By inversion \\
      & $\applye {\ctxl} {e_1}
      = \applye {\ctxl} {e_2} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
      & $\applye {\ctxl} {\sigma_1}
      = \applye {\ctxl} {\sigma_2} $
      & By Lemma~\ref{lemma:\SubstitutionExtensionInvarianceName} \\
    \end{longtable}
  \item Case \[\UPi\]
    Similar as Case \rul{U-LamAnn}.
  \item Case \[\UCastDn\]
    \begin{longtable}[l]{lll}
      & $\tctx \byinf \castdn e_1 \infto \sigma_1' $
      & Given \\
      & $\tctx \byinf e_1 \infto \sigma_1'' $
      & By inversion \\
      & $\tctx \byinf e_2 \infto \sigma_2'' $
      & Similarly \\
      & $\applye \ctxl {e_1} = \applye \ctxl {e_2} $
      & By induction hypothesis
    \end{longtable}
  \item Case \[\UCastUp\]
    Similar as Case \rul{U-CastDn}.
\end{itemize}

\qed

\section{Implicit Polymorphic Type System}

\subsection{Referred Lemmas}

\begin{lemma}[Unsolved Variable Addition For Extension]
  \label{lemma:dunfield:UnsolvedVariableAdditionForExtension}
  $\tctx_L, \tctx_R \exto \tctx_L, \genA, \tctx_R $.
\end{lemma}

\begin{lemma}[Solution Admissibility for Extension]
  \label{lemma:dunfield:SolutionAdmissibilityForExtension}
  If $\tctx \bywf \tau$,
  then $\tctx_L, \genA, \tctx_R \exto \tctx_L, \genA = \tau, \tctx_R $.
\end{lemma}

\begin{lemma}[Transitivity]
  \label{lemma:dunfield:Transitivity}
  If $\tctx \exto \ctxr$,
  and $\ctxr \exto \ctxl$,
  then $\tctx \exto \ctxl$.
\end{lemma}

\begin{lemma}[Reflexivity]
  \label{lemma:dunfield:Reflexivity}
  If $\tctx$ is well-formed,
  then $\tctx \exto \tctx$.
\end{lemma}

\begin{lemma}[Confluence of Completeness]
  \label{lemma:dunfield:ConfluenceOfCompleteness}
  If $\ctxr_1 \exto \cctx$,
  and $\ctxr_2 \exto \cctx$,
  then $\applye \cctx {\ctxr_1} = \applye \cctx {\ctxr_2} $.
\end{lemma}

\begin{lemma}[Substitution Extension Invariance]
  \label{lemma:dunfield:SubstitutionExtensionInvariance}
  If $\ctxl \bywf A $,
  and $\ctxl \exto \tctx $,
  then $\applye \tctx A = \applye \tctx {\applye \ctxl A} $,
  and $\applye \tctx A = \applye \ctxl {\applye \tctx A} $.
\end{lemma}

\begin{lemma}[Reflexivity of Declarative Subtyping]
  \label{lemma:dunfield:ReflexivityOfDeclarativeSubtyping}
  If $\dctx \bywf A$,
  then $\dctx \bysub A \dsub A $.
\end{lemma}

\begin{lemma}[Monotype Equality]
  \label{lemma:dunfield:MonotypeEquality}
  If $\dctx \bysub \sigma \dsub \tau$,
  then $\sigma = \tau$.
\end{lemma}

\begin{lemma}[Parallel Admissibility]
  \label{lemma:dunfield:ParallelAdmissibility}
  If $\tctx_L \exto \ctxr_L$,
  and $\tctx_L, \tctx_R \exto \ctxr_L, \ctxr_R$, then:
  \begin{itemize}
    \item $\tctx_L, \genA, \tctx_R  \exto \ctxr_L, \genA, \ctxr_R$
    \item If $\ctxr_L \bywf \tau'$,
      then $\tctx_L, \genA, \tctx_R \exto \ctxr_L, \genA = \tau', \ctxr_R $
    \item  If $\tctx_L \bywf \tau$,
      and $\ctxr_L \bywf \tau'$,
      and $\applye {\ctxr_L} \tau = \applye {\ctxr_L} {\tau'} $,
      then $\tctx_L, \genA = \tau, \tctx_R \exto \ctxr_L, \genA = \tau', \ctxr_R$.
  \end{itemize}
\end{lemma}

\begin{lemma}[Parallel Extension Solution]
  \label{lemma:dunfield:ParallelExtensionSolution}
  If $\tctx_L, \genA, \tctx_R \exto \ctxr_L, \genA = \tau', \ctxr_R $,
  and $\tctx_L \bywf \tau  $,
  and  $\applye {\ctxr_L} \tau = \applye {\ctxr_L} {\tau'} $,
  then $\tctx_L, \genA = \tau, \tctx_R \exto \ctxr_L, \genA = \tau', \ctxr_R $.
\end{lemma}

\begin{lemma}[Solved Variable Addition for Extension]
  \label{lemma:dunfield:SolvedVariableAdditionForExtension}
  If $\tctx_L \bywf \tau$,
  and $\tctx_L, \tctx_R \exto \tctx_L, \genA = \tau, \tctx_R $.
\end{lemma}

\begin{lemma}[Extension Order]\leavevmode
  \label{lemma:dunfield:ExtensionOrder}
  \begin{itemize}
  \item $\tctx_L, \varA, \tctx_R \exto \ctxr$,
    then $\ctxr = (\ctxr_L, \varA, \ctxr_R)$
    where $\tctx_L \exto \ctxr_L$.
    Moreover, if $\tctx_R$ is soft then $\ctxr_R$ is soft.
  \item $\tctx_L, \marker \genA, \tctx_R \exto \ctxr$,
    then $\ctxr = (\ctxr_L, \marker \genA, \ctxr_R)$
    where $\tctx_L \exto \ctxr_L$.
    Moreover, if $\tctx_R$ is soft then $\ctxr_R$ is soft.
  \item $\tctx_L, \genA, \tctx_R \exto \ctxr$,
    then $\ctxr = (\ctxr_L, \ctxl, \ctxr_R)$
    where $\tctx_L \exto \ctxr_L$,
    and $\ctxl$ is either $\genA$ or $\genA = \tau$ for some $\tau$.
  \item $\tctx_L, \genA = \tau, \tctx_R \exto \ctxr$,
    then $\ctxr = (\ctxr_L, \genA = \tau', \ctxr_R)$
    where $\tctx_L \exto \ctxr_L$,
    and $\applye {\ctxr_L} \tau = \applye {\ctxr_L} {\tau'}$.
  \item $\tctx_L, x : A, \tctx_R \exto \ctxr$,
    then $\ctxr = (\ctxr_L, x : A', \ctxr_R)$
    where $\tctx_L \exto \ctxr_L$,
    and $\applye {\ctxr_L} A = \applye {\ctxr_L} {A'}$.
    Moreover, if $\tctx_R$ is soft then $\ctxr_R$ is soft.
  \end{itemize}
\end{lemma}

\begin{lemma}[Reverse Declaration Order Preservation]
  \label{lemma:dunfield:ReverseDeclarationOrderPreservation}
  If $\tctx \exto \ctxr$ and $u$ and $v$ are both declared in $\tctx$ $u$ is
  declared to the left of $v$ in $\ctxr$,
  then $u$ is declared to the left of $v$ in $\tctx$.
\end{lemma}

\begin{lemma}[Stability of Complete Contexts]
  \label{lemma:dunfield:StabilityOfCompleteContexts}
  If $\tctx \exto \cctx $,
  then $\applye \cctx \tctx = \applye \cctx \cctx $.
\end{lemma}

\begin{lemma}[Finishing Types]
  \label{lemma:dunfield:FinishingTypes}
  If $\cctx \bywf A $,
  and $\cctx \exto \cctx' $,
  then $\applye \cctx A = \applye {\cctx'} A $.
\end{lemma}

\begin{lemma}[Finishing Completions]
  \label{lemma:dunfield:FinishingCompletions}
  If $\cctx \exto \cctx' $,
  then $\applye \cctx \cctx = \applye {\cctx'} {\cctx'} $.
\end{lemma}

\begin{lemma}[Extension Weakening]
  \label{lemma:dunfield:ExtensionWeakening}
  If $\tctx \bywf A$,
  and $\tctx \exto \ctxr$,
  then  $\ctxr \bywf A$.
\end{lemma}

\begin{lemma}[Substitution Typing]
  \label{lemma:dunfield:SubstitutionTyping}
  If $\tctx \bywf A$,
  then  $\tctx \bywf \applye \tctx A$.
\end{lemma}

\begin{proposition}[Weakening]
  \label{lemma:dunfield:Weakening}
  If $\dctx \bywf A$,
  then  $\dctx, \dctx' \bywf A$ by a derivation of the same size.
\end{proposition}

\subsection{Properties of Polymorphic Type Sanitization}

\begin{lemma}[\PolymorphicTypeSanitizationExtensionName]\leavevmode
  \label{lemma:\PolymorphicTypeSanitizationExtensionName}
  \PolymorphicTypeSanitizationExtensionBody
\end{lemma}

\proof

By induction on polymorphic type sanitization derivation.

\begin{itemize}
  \item Case \[\IAllPlus\]
    \begin{longtable}[l]{lll}
      & $\tctx[\genB, \genA] \exto \ctxl $
      & By induction hypothesis\\
      & $\tctx[\genA] \exto \tctx[\genB, \genA] $
      & By Lemma~\ref{lemma:dunfield:UnsolvedVariableAdditionForExtension} \\
      & $\tctx[\genA] \exto  \ctxl $
      & By Lemma~\ref{lemma:dunfield:Transitivity}
    \end{longtable}
  \item Case \[\IAllMinus\]
    \begin{longtable}[l]{lll}
      & $\tctx, \varA \exto \ctxl, \varA$
      & By induction hypothesis \\
      & $\tctx \exto \ctxl$
      & By inversion
    \end{longtable}
  \item Case \[\IPiPoly\]
    \begin{longtable}[l]{lll}
      & $\tctx \exto \ctxl_1$
      & By induction hypothesis \\
      & $\ctxl_1 \exto \ctxl$
      & By induction hypothesis \\
      & $\tctx \exto \ctxl$
      & By Lemma~\ref{lemma:dunfield:Transitivity}
    \end{longtable}
  \item Case \[\IUnit\]
    \begin{longtable}[l]{lll}
      & $\tctx$ is well-formed
      & By implicit assumption \\
      & $\tctx \exto \tctx$
      & By Lemma~\ref{lemma:dunfield:Reflexivity}
    \end{longtable}
  \item Case \[\ITVar\]
    \begin{longtable}[l]{lll}
      & $\tctx[\varA]$ is well-formed
      & By implicit assumption \\
      & $\tctx[\varA] \exto \tctx[\varA]$
      & By Lemma~\ref{lemma:dunfield:Reflexivity}
    \end{longtable}
  \item Case \[\IEVarAfterPoly\]
    \begin{longtable}[l]{lll}
      & $\tctx[\genA][\genB] \exto \tctx[\genA_1, \genA][\genB] $
      & By Lemma~\ref{lemma:dunfield:UnsolvedVariableAdditionForExtension} \\
      & $\tctx[\genA_1, \genA] \bywf \genA_1$
      & By \rul{EvarWF} \\
      & $\tctx[\genA_1, \genA][\genB] \exto \tctx[\genA_1, \genA][\genB = \genA_1] $
      & By Lemma~\ref{lemma:dunfield:SolutionAdmissibilityForExtension} \\
      & $\tctx[\genA][\genB] \exto \tctx[\genA_1, \genA][\genB = \genA_1] $
      & By Lemma~\ref{lemma:dunfield:Transitivity}
    \end{longtable}
  \item Case \[\IEVarBeforePoly\]
    \begin{longtable}[l]{lll}
      & $\tctx[\genB][\genA]$ is well-formed
      & By implicit assumption \\
      & $\tctx[\genB][\genA] \exto \tctx[\genB][\genA] $
      & By Lemma~\ref{lemma:dunfield:Reflexivity}
    \end{longtable}
\end{itemize}

\qed

\begin{lemma}[\PolymorphicTypeSanitizationSoundnessName]\leavevmode
  \label{lemma:\PolymorphicTypeSanitizationSoundnessName}
  \PolymorphicTypeSanitizationSoundnessBody
\end{lemma}

\proof

By induction on the polymorphic type sanitization derivation. These two parts
rely on each other, but the derivation get smaller so the proof terminates.

\begin{description}
  \item [Part 1] In this part, we regard $s = +$.
    \begin{itemize}
      \item \[\IAllPlus\]
        \begin{longtable}[l]{lll}
          & $\ctxl \exto \cctx$
          & Given \\
          & $\applye {\tctx[\genA]} {\forall \varA. A } = \forall \varA . A $
          & Given \\
          & $\applye {\tctx[\genB, \genA]} {A \subst \varA \genB}
          = A \subst \varA \genB $
          & Follows directly \\
          & $\applye \cctx \ctxl \bysub \applye \cctx {A \subst \varA \genB}
          \dsub \applye \cctx \sigma $
          & By induction hypothesis \\
          & $\applye \cctx \ctxl \bysub {\applye \cctx A}
          \subst \varA {\applye \cctx \genB}
          \dsub \applye \cctx \sigma $
          & By property of substitution \\
          & $\applye \cctx \ctxl \bysub
          {\applye \cctx {\forall \varA. A}}
          \dsub \applye \cctx \sigma $
          & By \rul{$\dsub \forall$ L} with $\tau = \applye \cctx \genB$
        \end{longtable}
      \item \[\IPiPoly\]
        \begin{longtable}[l]{lll}
          & $\applye \tctx {A_1 \to A_2} = A_1 \to A_2 $
          & Given \\
          & $\applye \tctx {A_1} = A_1 $
          & Follows directly \\
          & $\ctxl_1 \exto \ctxl $
          & By Lemma~\ref{lemma:\PolymorphicTypeSanitizationExtensionName} \\
          & $\ctxl \exto \cctx $
          & Given \\
          & $\ctxl_1 \exto \cctx $
          & By Lemma~\ref{lemma:dunfield:Transitivity} \\
          & $\applye \cctx {\ctxl_1} \bysub
          \applye \cctx {\sigma_1}
          \dsub
          \applye \cctx {A_1}
          $
          & By Part 2 \\
          & $\applye \cctx {\ctxl} \bysub
          \applye \cctx {\sigma_1}
          \dsub
          \applye \cctx {A_1}
          $
          & By Lemma~\ref{lemma:dunfield:ConfluenceOfCompleteness} \\
          & $\applye {\ctxl_1} {\applye {\ctxl_1} {A_2}}
          = {\applye {\ctxl_1} {A_2}} $
          & \\
          & $\applye \cctx {\ctxl} \bysub
          \applye \cctx {\applye {\ctxl_1} {A_2}}
          \dsub
          \applye \cctx {\sigma_2}
          $
          & By induction hypothesis \\
          & $\applye \cctx {\ctxl} \bysub
          \applye \cctx {A_2}
          \dsub
          \applye \cctx {\sigma_2}
          $
          & By Lemma~\ref{lemma:dunfield:SubstitutionExtensionInvariance} \\
          & $\applye \cctx {\ctxl} \bysub
          \applye \cctx {A_1 \to A_2}
          \dsub
          \applye \cctx {\sigma_1 \to \sigma_2}
          $
          & By \rul{$\dsub \to$}
        \end{longtable}
      \item \[\IUnit\]
        \begin{longtable}[l]{lll}
          & $\applye \cctx \tctx \bysub \Unit \dsub \Unit $
          & By \rul{$\dsub$Unit}
        \end{longtable}
      \item \[\ITVar\]
        \begin{longtable}[l]{lll}
          & $\applye \cctx {\tctx[\genA]} \bysub
          \applye \cctx \genA \dsub \applye \cctx \genA $
          & By Lemma~\ref{lemma:dunfield:ReflexivityOfDeclarativeSubtyping}
        \end{longtable}
      \item \[\IEVarAfterPoly\]
        \begin{longtable}[l]{lll}
          & $\applye {\tctx[\genA_1, \genA][\genB = \genA_1]} {\genA_1}$ & \\
          & $= \applye {\tctx[\genA_1, \genA][\genB = \genA_1]} \genB$ & \\
          & $= \genA_1 $
          & By definition of context application \\
          & $\tctx[\genA_1, \genA][\genB = \genA_1] \exto \cctx $
          & Given \\
          & $\applye \cctx \genB = \applye \cctx {\genA_1} $
          & By Lemma~\ref{lemma:dunfield:SubstitutionExtensionInvariance} \\
          & $\applye \cctx \tctx \bysub \applye \cctx \genB \dsub
          \applye \cctx {\genA_1} $
          & By Lemma~\ref{lemma:dunfield:ReflexivityOfDeclarativeSubtyping}
        \end{longtable}
      \item \[\IEVarBeforePoly\]
        \begin{longtable}[l]{lll}
          & $\applye \cctx {\tctx[\genA]} \bysub
          \applye \cctx \genB \dsub \applye \cctx \genB $
          & By Lemma~\ref{lemma:dunfield:ReflexivityOfDeclarativeSubtyping}
        \end{longtable}
    \end{itemize}
  \item [Part 2] In this part, we regard $s = -$.
    \begin{itemize}
      \item \[\IAllMinus\]
        \begin{longtable}[l]{lll}
          & $\ctxl \exto \cctx $
          & Given \\
          & $\ctxl, \varA \exto \cctx, \varA $
          & By \rul{$\exto$ Uvar} \\
          & $\applye \tctx {\forall \varA. A} = \forall \varA . A $
          & Given \\
          & $\applye {\tctx, \varA} A = A $
          & Follows directly \\
          & $\applye {\cctx, \varA} {\tctx, \varA} \bysub
          \applye {\cctx, \varA} A \dsub
          \applye {\cctx, \varA} \sigma
          $
          & By induction hypothesis \\
          & $\applye {\cctx} {\tctx}, \varA \bysub
          \applye {\cctx} A \dsub
          \applye {\cctx} \sigma
          $
          & By definition of context application \\
          & $\applye {\cctx} {\tctx} \bysub
          \applye {\cctx} {\forall \varA. A} \dsub
          \applye {\cctx} \sigma
          $
          & By \rul{$\dsub \forall$ L}
        \end{longtable}
      \item \[\IPiPoly\]
        Similar as in Part 1.
      \item \[\IUnit\]
        Similar as in Part 1.
      \item \[\ITVar\]
        Similar as in Part 1.
      \item \[\IEVarAfterPoly\]
        Similar as in Part 1.
      \item \[\IEVarBeforePoly\]
        Similar as in Part 1.
    \end{itemize}
\end{description}

\qed

\begin{lemma}[\PolymorphicTypeSanitizationCompletenessName]
  \label{lemma:\PolymorphicTypeSanitizationCompletenessName}
  \PolymorphicTypeSanitizationCompletenessBody
\end{lemma}

\proof

By induction on the height of subtyping derivation.

\begin{description}
  \item [Part 1]
    We have $\applye \cctx \tctx \bysub \tau \dsub \applye \cctx
    A $. We now case analyze the shape of $A$.
    \begin{itemize}
    \item Case $A = \genB$.
      \begin{longtable}[l]{lll}
        & $\genA \notin FV(A)$
        & Given \\
        & $\genA \neq \genB$
        & Follows directly \\
        & $\applye \cctx \genB = \tau_2$
        & Assume \\
        & $\applye \cctx \tctx \bysub \tau \dsub \tau_2 $
        & Given \\
        & $\tau = \tau_2$
        & By Lemma~\ref{lemma:dunfield:MonotypeEquality} \\
        & $\applye \tctx \genB = \genB$
        & Given \\
        & $\genB \in unsolved(\tctx)$
        & Follows directly \\
      \end{longtable}
      According to whether $\genB$ is on the left of $\genA$ or right, we have
      two cases.
      \begin{itemize}
      \item SubCase $\tctx = \tctx_1, \genA, \tctx_3, \genB, \tctx_4 $.
        \begin{longtable}[l]{lll}
          & $\tctx_1, \genA, \tctx_3, \genB, \tctx_4 \bymsa \genB \sa \genA_1
          \toctxo_1, \genA_1, \genA, \tctx_3, \genB = \genA_1, \tctx_4
          $
          & By \rul{I-EVarAfterPoly} \\
          & $\tctx_1, \genA, \tctx_3, \genB, \tctx_4 \exto \cctx $
          & Given \\
          & $\cctx = \cctx[\genA = \tau']$
          & Assume \\
          & $\tctx_1, \genA_1 = \tau, \genA, \tctx_3, \genB, \tctx_4 \exto
          \cctx[\genA_1 = \tau, \genA = \tau'] $
          & By Lemma~\ref{lemma:dunfield:ParallelAdmissibility} \\
          & $\applye {\cctx[\genA_1 = \tau, \genA = \tau']} \genB = \tau $
          & Known \\
          & $\tctx_1, \genA_1 = \tau, \genA, \tctx_3, \genB = \genA_1, \tctx_4 \exto
          \cctx[\genA_1 = \tau, \genA = \tau'] $
          & By Lemma~\ref{lemma:dunfield:ParallelExtensionSolution} \\
          & $\tctx_1, \genA_1, \genA , \tctx_3, \genB = \genA_1,
          \tctx_4
          \exto \tctx_1, \genA_1 = \tau, \genA, \tctx_3, \genB =
          \genA_1, \tctx_4 $
          &  By Lemma~\ref{lemma:dunfield:SolutionAdmissibilityForExtension} \\
          & $\tctx_1, \genA_1, \genA, \tctx_3, \genB = \genA_1,
          \tctx_4
          \exto
          \cctx[\genA_1 = \tau, \genA = \tau'] $
          & By Lemma~\ref{lemma:dunfield:Transitivity} \\
          & $\cctx' = \cctx[\genA_1 = \tau, \genA = \tau']$
          & Choose \\
          & $\cctx[\genA = \tau'] \exto \cctx[\genA_1 = \tau, \genA = \tau']$
          & By Lemma~\ref{lemma:dunfield:SolvedVariableAdditionForExtension} \\
          & $\applye {\cctx'} {\genA_1} = \tau $
          & Follows directly
        \end{longtable}
      \item SubCase $\tctx = \tctx_1, \genB, \tctx_3, \genA, \tctx_4 $.
        \begin{longtable}[l]{lll}
          & $\tctx_1, \genB, \tctx_3, \genA, \tctx_4 \bymsa \genB \sa \genB
          \toctxo_1, \genB, \tctx_3, \genA, \tctx_4
          $
          & By \rul{I-EVarBeforePoly} \\
          & $\tctx_1, \genB, \tctx_3, \genA, \tctx_4 \exto \cctx $
          & Given \\
          & $\cctx' = \cctx$
          & Choose \\
          & $\cctx \exto \cctx'$
          & By Lemma~\ref{lemma:dunfield:Reflexivity} \\
          & $\applye {\cctx'} \genB = \tau$
          & Known \\
        \end{longtable}
      \end{itemize}
    \item Case $A = \varA$.
      \begin{longtable}[l]{lll}
        & $\applye \cctx \varA = \varA$
        & By definition of context application \\
        & $\applye \cctx \tctx \bysub \tau \dsub \varA$
        & Given \\
        & $\tau = \varA$
        & By inversion \\
        & $\tctx_1 \bywf \varA$
        & Given \\
        & $\varA$ is declared to the left of $\genA$ in $\tctx $ \\
        & $\tctx_1, \genA, \tctx_2 \bymsa \varA \sa \varA  \toctxo_1, \genA, \tctx_2 $
        & By \rul{I-TVar} \\
        & $\cctx' = \cctx$
        & Choose \\
        & $\cctx \exto \cctx'$
        & By Lemma~\ref{lemma:dunfield:Reflexivity} \\
        & $\applye {\cctx'} \varA = \varA$
        & By definition of context application
      \end{longtable}
    \item Case $A = \Unit$.
      \begin{longtable}[l]{lll}
        & $\applye \cctx \Unit = \Unit$
        & By definition of context application \\
        & $\applye \cctx \tctx \bysub \tau \dsub \Unit$
        & Given \\
        & $\tau = \Unit$
        & By inversion \\
        & $\tctx_1, \genA, \tctx_2 \bymsa \Unit \sa \Unit  \toctxo_1, \genA, \tctx_2 $
        & By \rul{I-Unit} \\
        & $\cctx' = \cctx$
        & Choose \\
        & $\cctx \exto \cctx'$
        & By Lemma~\ref{lemma:dunfield:Reflexivity} \\
        & $\applye {\cctx'} \varA = \varA$
        & By definition of context application
      \end{longtable}
    \item Case $A = A_1 \to A_2$
      \begin{longtable}[l]{lll}
        & $\applye \cctx {A_1 \to A_2} = \applye \cctx {A_1} \to \applye \cctx {A_2}$
        & By definition of context application \\
        & $\applye \cctx \tctx \bysub \tau \dsub
        \applye \cctx {A_1} \to \applye \cctx {A_2}$
        & Given \\
        & $\tau = \tau_1 \to \tau_2 $
        & By inversion \\
        & $\applye \cctx \tctx \bysub \applye \cctx {A_1} \dsub \tau_1  $
        & As above \\
        & $\applye \cctx \tctx \bysub \tau_2 \dsub \applye \cctx {A_2}$
        & As above \\
        & $\tctx \bypsa A_1 \sa \sigma_1 \toctx $
        & By Part 2 \\
        & $\ctxl = \ctxl_1, \genA, \ctxl_2$
        & As above \\
        & $\ctxl_1 \bywf \sigma_1$
        & As above \\
        & $\ctxl \exto \cctx_1 $
        & As above \\
        & $\cctx \exto \cctx_1$
        & As above \\
        & $\applye {\cctx_1} {\sigma_1} = \tau_1$
        & As above \\
        & $\tctx \exto \ctxl$
        & By Lemma~\ref{lemma:\PolymorphicTypeSanitizationExtensionName}\\
        & $\tctx_1 \exto \ctxl_1$
        & By Lemma~\ref{lemma:dunfield:ExtensionOrder}\\
        & $\tctx \exto \cctx_1 $
        & By Lemma~\ref{lemma:dunfield:Transitivity} \\
        & $\applye {\cctx} {\cctx} \bysub \tau_2 \dsub \applye {\cctx}
        {A_2}$
        & By Lemma~\ref{lemma:dunfield:StabilityOfCompleteContexts} \\
        & $\applye {\cctx_1} {\cctx_1} \bysub \tau_2 \dsub \applye {\cctx}
        {A_2}$
        & By Lemma~\ref{lemma:dunfield:FinishingCompletions} \\
        & $\applye {\cctx_1} {\tctx} \bysub \tau_2 \dsub \applye {\cctx}
        {A_2}$
        & By Lemma~\ref{lemma:dunfield:StabilityOfCompleteContexts} \\
        & $\applye {\cctx_1} {\ctxl} \bysub \tau_2 \dsub \applye {\cctx}
        {A_2}$
        & By Lemma~\ref{lemma:dunfield:ConfluenceOfCompleteness} \\
        & $\applye {\cctx_1} {\ctxl} \bysub \tau_2 \dsub \applye {\cctx_1}
        {A_2}$
        & By Lemma~\ref{lemma:dunfield:FinishingTypes} \\
        & $\applye {\cctx_1} {\ctxl} \bysub \tau_2 \dsub \applye {\cctx_1}
        {\applye {\ctxl} {A_2}}$
        & By Lemma~\ref{lemma:dunfield:SubstitutionExtensionInvariance} \\
        & $\ctxl \bymsa \applye \ctxl {A_2} \sa \sigma_2 \toctxr $
        & By induction hypothesis \\
        & $\ctxr = \ctxr_1, \genA, \ctxr_2 $
        & As above \\
        & $\ctxr \exto \cctx_2$
        & As above \\
        & $\cctx_1 \exto \cctx_2$
        & As above \\
        & $\ctxr_1 \bywf \sigma_2$
        & As above \\
        & $\applye {\cctx_2} {\sigma_2} = \tau_2$
        & As above \\
        & $\applye {\cctx_2} {\sigma_1} = \tau_1$
        & By Lemma~\ref{lemma:dunfield:FinishingTypes} \\
        & $\ctxl_1 \exto \ctxr_1$
        & By Lemma~\ref{lemma:dunfield:ExtensionOrder}\\
        & $\ctxr_1 \bywf \sigma_1 $
        & By Lemma~\ref{lemma:dunfield:ExtensionWeakening} \\
        & $\ctxr_1 \bywf \sigma_1 \to \sigma_2$
        & Follows directly \\
        & $\tctx \bypsa A_1 \sa \sigma_1 \toctx $
        & Known \\
        & $\ctxl \bymsa \applye \ctxl {A_2} \sa \sigma_2 \toctxr $
        & Known \\
        & $\tctx \bymsa A_1 \to A_2 \sa \sigma_1 \to \sigma_2 \toctxr $
        & By \rul{I-Pi-Poly} \\
        & $\cctx \exto \cctx_2$
        & By Lemma~\ref{lemma:dunfield:Transitivity} \\
        & $\cctx' = \cctx_2$
        & Choose \\
        & $\applye {\cctx'} {\sigma_1 \to \sigma_2} = \tau_1 \to \tau_2$
        & By definition of context application
      \end{longtable}
    \item Case $A = \forall \varA.  A_1$
      \begin{longtable}[l]{lll}
        & $\applye \cctx {\forall \varA . A_1} = \forall \varA. \applye \cctx {A_1} $
        & By definition of context application \\
        & $\applye \cctx \tctx \bysub \tau \dsub
        \forall \varA. \applye \cctx {A_1}$
        & Given \\
        & $\applye \cctx \tctx, \varA \bysub \tau \dsub
        \applye \cctx {A_1}$
        & By inversion \\
        & $\applye {\cctx, \varA} {\tctx, \varA} \bysub \tau \dsub
        \applye {\cctx, \varA} {A_1}$
        & Rewrite the judgment \\
        & $\tctx, \varA \bymsa A_1 \sa \sigma \toctx $
        & By induction hypothesis \\
        & $\sa$ will not add new variables in the end
        & Follows from definition \\
        & $\ctxl = \ctxl_1, \genA, \ctxl_2, \varA $
        & By induction hypothesis and Lemma~\ref{lemma:dunfield:ExtensionOrder}
        and above \\
        & $\ctxl_1 \bywf \sigma $
        & By induction hypothesis \\
        & $\ctxl \exto \cctx_1 $
        & As above \\
        & $\cctx, \varA \exto \cctx_1 $
        & As above \\
        & $\applye {\cctx_1} \sigma = \tau$
        & As above \\
        & $\cctx_1  = \cctx_2, \varA, \cctx_3 $
        & By Lemma~\ref{lemma:dunfield:ExtensionOrder} \\
        & $\ctxl_1, \genA, \ctxl_2  \exto \cctx_2 $
        & As above \\
        & $\cctx \exto \cctx_2$
        & As above \\
        & $\ctxl_1, \genA, \ctxl_2 \bywf \sigma$
        & By Lemma~\ref{lemma:dunfield:Weakening} \\
        & $\cctx_2 \bywf \sigma$
        & By Lemma~\ref{lemma:dunfield:ExtensionWeakening} \\
        & $\applye {\cctx_1} \sigma = \applye {\cctx_2} \sigma = \tau$
        & Follows directly \\
        & $\tctx  \bymsa \forall \varA. A_1 \sa \sigma \toctx_1, \genA, \ctxl_2 $
        & By \rul{I-All-Minus} \\
        & $\cctx' = \cctx_2$
        & Choose
      \end{longtable}
    \end{itemize}
  \item [Part 2]
    We have $\applye \cctx \tctx \bysub \applye \cctx
    A \dsub \tau$. We now case analyze the shape of $A$.
    These cases are mostly symmetric as in Part 1.
    The only exception is when $A$ is a polymorphic type.
    \begin{itemize}
      \item Case $A = \forall \varA. A_1$
      \begin{longtable}[l]{lll}
        & $\applye \cctx {\forall \varA . A_1} = \forall \varA. \applye \cctx {A_1} $
        & By definition of context application \\
        & $\applye \cctx \tctx \bysub
        \forall \varA. \applye \cctx {A_1} \dsub \tau $
        & Given \\
        & $\applye \cctx \tctx \bysub
        (\applye \cctx {A_1}) \subst \varA {\tau_1}
        \dsub \tau $
        & By inversion \\
        & $\applye \cctx \tctx \bywf \tau_1 $
        & Same as above \\
        & $\tau_1$ contains no existential variable
        & Follows directly \\
        & $\applye \cctx {\tau_1} = \tau_1$
        & Follows directly \\
        & $\applye \cctx \tctx \bysub
        \applye \cctx {A_1 \subst \varA {\tau_1}}
        \dsub \tau $
        & Rewrite the judgment \\
        & $\applye \cctx \tctx \bysub
        \applye \cctx {A_1 \subst \varA \genB \subst \genB {\tau_1}}
        \dsub \tau $
        & Rewrite the judgment \\
        & $\tctx = \tctx_1 , \genA, \tctx_2$
        & Given \\
        & $\tctx \exto \cctx$
        & Given \\
        & $\cctx = \cctx[\genA = \tau'] $
        & By Lemma~\ref{lemma:dunfield:ExtensionOrder} \\
        & $\applye {\cctx[\genB = \tau_1, \genA = \tau']} {\tctx_1, \genB,
          \genA, \tctx_2} \bysub
        \applye {\cctx[\genB = \tau_1, \genA = \tau']} {A_1 \subst \varA \genB}
        \dsub \tau $
        & Rewrite the judgment \\
        & $\tctx_1, \genB, \genA, \tctx_2 \bypsa A_1 \subst \varA \genB \sa \sigma \toctxr $
        & By induction hypothesis \\
        & $\ctxr = \ctxr_1, \genA, \ctxr_2$
        & As above \\
        & $\ctxr_1 \bywf \sigma $
        & As above \\
        & $\ctxr \exto \cctx_1 $
        & As above \\
        & $\cctx[\genB = \tau_1, \genA = \tau'] \exto \cctx_1 $
        & As above \\
        & $\applye {\cctx_1} \sigma = \tau$
        & As above \\
        & $\tctx_1, \genA, \tctx_2 \bypsa \forall \varA. A_1 \sa \sigma \toctxr $
        & By \rul{I-All-Plus} \\
        & $\cctx' = \cctx_1$
        & Choose \\
        & $\cctx[\genA = \tau'] \exto \cctx[\genB = \tau_1, \genA = \tau']$
        & By Lemma~\ref{lemma:dunfield:SolvedVariableAdditionForExtension} \\
        & $\cctx \exto \cctx_1$
        & By Lemma~\ref{lemma:dunfield:Transitivity} \\
      \end{longtable}
    \end{itemize}
\end{description}

\qed

\begin{corollary}[\PolymorphicTypeSanitizationCompletenessSubtypingName]
  \label{lemma:\PolymorphicTypeSanitizationCompletenessSubtypingName}
  \PolymorphicTypeSanitizationCompletenessSubtypingBody
\end{corollary}

\begin{description}
  \item [Part 1]
    \mbox{} % an empty line to make sure long table appear after proof
    \begin{longtable}[l]{lll}
      & $\applye \cctx \genA = \tau$
      & Assume \\
      & $\applye \cctx \tau = \tau$
      & Since $\tau$ contains no existential variables\\
      & $\genA \in unsolved(\tctx)$
      & Given \\
      & $\tctx = \tctx_1, \genA, \tctx_2$
      & Assume \\
      & $\cctx = \cctx_1, \genA = \tau', \cctx_2$
      & By Lemma~\ref{lemma:dunfield:ExtensionOrder} \\
      & $\tctx_1 \exto \cctx_1$
      & Same as above \\
      & $\applye \cctx \genA = \applye {\cctx_1} \genA = \tau$
      & By definition of context application \\
      & $\cctx_1 \bywf \tau$
      & By Lemma~\ref{lemma:dunfield:SubstitutionTyping} \\
      & Since $\tau$ contains no existential variables\\
      & And $\tctx_1$ contains all type variables in $\cctx_1$\\
      & $\tctx_1 \bywf \tau$
      & Follows directly \\
      & $\applye \cctx \tctx \bysub \tau \dsub \applye \cctx A $
      & Given \\
      & $\tctx[\genA] \bymsa A \sa \sigma \toctxr $
      & By Lemma~\ref{lemma:\PolymorphicTypeSanitizationCompletenessName} \\
      & $\ctxr = \ctxr_1, \genA, \ctxr_2 $
      & As above \\
      & $\ctxr_1 \bywf \sigma$
      & As above \\
      & $\ctxr \exto \cctx'$
      & As above \\
      & $\cctx \exto \cctx'$
      & As above \\
      & $\applye {\cctx'} \sigma =\tau$
      & As above \\
      & $\applye {\cctx'} \genA =\tau$
      & By Lemma~\ref{lemma:dunfield:FinishingTypes} \\
      & $\tctx[\genA] \bysub \genA \tsub A \toctxr_1, \genA = \sigma,
      \ctxr_2 $
      & By \rul{$\tsub$ InstL} \\
      & $\ctxr_1, \genA = \sigma, \ctxr_2
      \exto \cctx'
      $
      & By Lemma~\ref{lemma:dunfield:ParallelExtensionSolution}
    \end{longtable}
  \item [Part 2]
    Similar as Part 1.
\end{description}

\qed

